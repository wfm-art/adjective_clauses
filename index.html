<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adjective Clauses Master ğŸ·ï¸</title>
    
    <style>
        :root {
            /* --- PALETA MAESTRA (GOLDEN FORMAT) --- */
            --primary: #007bff;       /* Azul Principal */
            --dark-blue: #0056b3;     /* Azul Oscuro */
            --green: #28a745;         /* Verde Ã‰xito */
            --red: #dc3545;           /* Rojo Error */
            --yellow: #ffc107;        /* Amarillo Alerta */
            --orange: #fd7e14;        /* Naranja Destacados */
            
            /* Variables de Tema */
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* MODO OSCURO */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --tab-bg: #333;
            --tab-active-bg: #bb86fc;
            --tab-text: #aaa;
            --tab-active-text: #000;
            --border-color: #444;
            --light-gray-bg: #2c2c2c;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; }
        
        .main-container { max-width: 950px; margin: 0 auto; background: var(--container-bg); border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        
        /* HEADER */
        header { background: var(--header-bg); color: white; padding: 25px 20px; text-align: center; position: relative; }
        header h1 { margin: 10px 0 5px; font-size: 2rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        header p { margin: 5px 0 0; opacity: 0.95; font-size: 1.1rem; }
        
        /* BOTONES SUPERIORES (Translate & Theme) */
        .top-btn { position: absolute; top: 15px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 1rem; transition: all 0.2s; font-weight: bold; }
        .top-btn:hover { background: rgba(255,255,255,0.4); transform: scale(1.05); }
        .lang-btn { left: 15px; }
        .theme-btn { right: 15px; }

        /* TABS */
        .tab-nav { display: flex; background: var(--tab-bg); overflow-x: auto; -webkit-overflow-scrolling: touch; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-size: 1rem; color: var(--tab-text); border-bottom: 4px solid transparent; font-weight: 600; white-space: nowrap; transition: all 0.2s; min-width: 100px; }
        .tab-btn.active { background: var(--tab-active-bg); color: var(--tab-active-text); border-bottom-color: var(--yellow); }
        
        .tab-content { display: none; padding: 25px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .action-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; margin: 5px; box-shadow: var(--shadow); transition: transform 0.1s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .action-btn.secondary { background: var(--green); }
        .action-btn.warning { background: var(--yellow); color: #333; }
        .explain-btn { padding: 5px 12px; font-size: 0.85rem; border-radius: 20px; background: var(--dark-blue); }

        .metaphor-box { text-align: center; padding: 30px; background: var(--light-gray-bg); border-radius: 12px; border: 2px dashed var(--border-color); margin-bottom: 30px; }
        .metaphor-title { color: var(--primary); margin-bottom: 20px; font-size: 1.5rem; }
        .emoji-large { font-size: 4rem; display: block; animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; margin: 30px 0; box-shadow: var(--shadow); background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        /* VISUALIZADOR DE FÃ“RMULA (CSS RESTAURADO) */
        .formula-visualizer { background: var(--container-bg); padding: 20px; border-radius: 12px; border: 2px solid var(--primary); margin-top: 30px; text-align: center; }
        .visualizer-display { font-size: 1.3rem; margin: 20px 0; padding: 15px; background: var(--light-gray-bg); border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; align-items: center; }
        .vis-part { padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
        .vis-antecedent { background: #e3f2fd; color: var(--primary); border: 1px solid #b3d7ff; }
        .vis-connector { background: #fff3cd; color: #856404; font-weight: bold; border: 1px solid #ffeeba; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .vis-clause { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .vis-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }

        .grammar-table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 20px 0; background: var(--container-bg); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .grammar-table th, .grammar-table td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        .grammar-table th { background: rgba(0,123,255,0.08); color: var(--primary); font-weight: bold; text-transform: uppercase; font-size: 0.9rem; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--container-bg); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3); animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #999; }
        .phrase-item { background: var(--light-gray-bg); padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }

        /* FLASHCARDS */
        .flashcard-container { perspective: 1000px; width: 100%; max-width: 500px; height: 320px; margin: 20px auto; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .flashcard-container.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; border-radius: 15px; background: var(--container-bg); border: 1px solid var(--border-color); }
        .flashcard-back { transform: rotateY(180deg); background: #fffcf5; }
        body.dark-mode .flashcard-back { background: #2a2a2a; }
        .tts-icon { font-size: 2rem; margin-top: 20px; cursor: pointer; display: inline-block; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }

        /* PRACTICE */
        .quiz-question { background: var(--light-gray-bg); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 6px solid var(--yellow); }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
        @media (min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }
        .option-btn { background: var(--container-bg); border: 2px solid var(--border-color); padding: 15px; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s; display: flex; align-items: center; }
        .option-btn.correct { background: #d4edda !important; border-color: #28a745 !important; color: #155724; font-weight: bold; }
        .option-btn.incorrect { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24; opacity: 0.8; }
        
        .story-text { line-height: 2.4; font-size: 1.15rem; background: var(--light-gray-bg); padding: 25px; border-radius: 12px; border: 2px solid var(--border-color); }
        select.story-input { border: 2px solid var(--primary); padding: 5px; border-radius: 6px; font-size: 1rem; background: var(--container-bg); color: var(--text-color); }
        select.story-input.correct { border-color: var(--green); background: #d4edda; color: #155724; }
        select.story-input.incorrect { border-color: var(--red); background: #f8d7da; color: #721c24; }

        /* DRAG DROP */
        .drag-area { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 25px; }
        .drop-zone { flex: 1; min-width: 300px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 15px; padding: 20px; min-height: 300px; display: flex; flex-direction: column; align-items: center; }
        .drop-zone.drag-over { background: rgba(0,123,255,0.1); border-color: var(--primary); transform: scale(1.02); }
        .drag-item { background: var(--primary); color: white; padding: 12px 20px; margin: 8px; border-radius: 50px; display: inline-flex; align-items: center; cursor: grab; touch-action: none; z-index: 10; }
        .drag-item:active { cursor: grabbing; transform: scale(1.1); }

        .hidden { display: none; }
        .feedback { margin-top: 10px; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div class="main-container">
    <header>
        <h1>Adjective Clauses Master ğŸ·ï¸</h1>
        <p data-lang-key="subtitle">Conecta ideas con: Que, Quien, Donde, Lo que</p>
        
        <button class="top-btn lang-btn" onclick="toggleLang()">ğŸŒ ES/EN</button>
        <button class="top-btn theme-btn" onclick="toggleTheme()">ğŸŒ“</button>
    </header>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('metaphor')" data-lang-key="tab_concept">ğŸ§  Concepto</button>
        <button class="tab-btn" onclick="openTab('formula')" data-lang-key="tab_formula">ğŸ“ FÃ³rmula</button>
        <button class="tab-btn" onclick="openTab('phrases')" data-lang-key="tab_phrases">ğŸ’¬ Frases</button>
        <button class="tab-btn" onclick="openTab('practice')" data-lang-key="tab_practice">ğŸ® PrÃ¡ctica</button>
        <button class="tab-btn" onclick="openTab('flashcards')" data-lang-key="tab_flashcards">âš¡ Flashcards</button>
    </div>

    <!-- PESTAÃ‘A 1: CONCEPTO -->
    <div id="metaphor" class="tab-content active">
        <div class="metaphor-box">
            <h2 class="metaphor-title" data-lang-key="meta_title">La MetÃ¡fora: La Etiquetadora (The Label Maker)</h2>
            <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 25px;">
                <span class="emoji-large">ğŸ“¦</span><span class="emoji-large">ğŸ·ï¸</span><span class="emoji-large">âœ¨</span>
            </div>
            <p data-lang-key="meta_desc1">Imagina que tienes una caja genÃ©rica llamada "El libro" (The book). ğŸ“¦</p>
            <p data-lang-key="meta_desc2">Una <strong style="color:var(--primary)">ClÃ¡usula Adjetiva</strong> es como una <strong style="color:var(--orange)">etiqueta adhesiva</strong> que pegas en esa caja para hacerla especÃ­fica.</p>
        </div>

        <h3 style="color: var(--primary); text-align: center;" data-lang-key="video_title">ğŸ“¹ Video Tutorial Interactivo</h3>
        <div class="video-container">
            <iframe src="https://drive.google.com/file/d/1GvLKweVVyGK7NV56g-Lo3DvjSXqjQwW2/preview" allow="autoplay"></iframe>
        </div>

        <!-- FÃ³rmula Visual Interactiva (RESTAURADO) -->
        <div class="formula-visualizer">
            <h3 style="color: var(--primary); margin-top: 0;" data-lang-key="vis_title">ğŸ§™â€â™‚ï¸ FÃ³rmula Visual Interactiva</h3>
            <p data-lang-key="vis_desc">Haz clic en los botones para construir la frase y ver cÃ³mo cambia el conector.</p>
            
            <div class="visualizer-display">
                <span id="vis-ant" class="vis-part vis-antecedent">La persona ğŸ‘¤</span>
                <span id="vis-con" class="vis-part vis-connector">+ QUIEN ğŸ”— +</span>
                <span id="vis-cla" class="vis-part vis-clause">me ayudÃ³ es amable. ğŸ˜Š</span>
            </div>

            <div class="vis-controls">
                <p><strong data-lang-key="vis_choose">Elige el Antecedente:</strong></p>
                <button class="action-btn secondary" onclick="updateVisualizer('persona')">ğŸ‘¤ Persona</button>
                <button class="action-btn secondary" onclick="updateVisualizer('cosa')">ğŸš— Cosa/Animal</button>
                <button class="action-btn secondary" onclick="updateVisualizer('lugar')">ğŸ™ï¸ Lugar</button>
            </div>
        </div>
    </div>

    <!-- PESTAÃ‘A 2: FÃ“RMULA -->
    <div id="formula" class="tab-content">
        <h3 data-lang-key="formula_title">ğŸ“ La FÃ³rmula de ConexiÃ³n</h3>
        <p data-lang-key="formula_desc">El "pegamento" (conector) cambia dependiendo de quÃ© estamos describiendo.</p>
        
        <table class="grammar-table">
            <thead>
                <tr>
                    <th data-lang-key="th_ant">Antecedente</th>
                    <th data-lang-key="th_con">Conector ğŸ”—</th>
                    <th data-lang-key="th_ex">Ejemplo Completo ğŸ“</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Personas/Cosas</strong></td>
                    <td><strong>que</strong></td>
                    <td>El libro ğŸ“˜ <strong>que</strong> leÃ­.</td>
                </tr>
                <tr>
                    <td><strong>Personas (Prep.)</strong></td>
                    <td><strong>quien</strong></td>
                    <td>La mujer ğŸ‘© <strong>con quien</strong> hablÃ©.</td>
                </tr>
                <tr>
                    <td><strong>Lugares</strong></td>
                    <td><strong>donde</strong></td>
                    <td>El parque ğŸŒ³ <strong>donde</strong> jugamos.</td>
                </tr>
                 <tr>
                    <td><strong>Ideas (Abstract)</strong></td>
                    <td><strong>lo que</strong></td>
                    <td>No sÃ© ğŸ¤” <strong>lo que</strong> quieres.</td>
                </tr>
            </tbody>
        </table>

        <div style="background: var(--light-gray-bg); padding: 20px; border-radius: 12px; margin-top: 30px; border-left: 5px solid var(--yellow);">
            <h4 style="margin-top: 0;" data-lang-key="rule_title">âš ï¸ Regla de Oro</h4>
            <p data-lang-key="rule_desc">Si hay una preposiciÃ³n (a, con, de...) antes del conector y es persona, DEBES usar <strong>QUIEN</strong>.</p>
        </div>
    </div>

    <!-- PESTAÃ‘A 3: FRASES (EXPANDIDO A 10) -->
    <div id="phrases" class="tab-content">
        <h3 data-lang-key="phrases_title">ğŸ’¬ Banco de Frases Ãštiles</h3>
        <p data-lang-key="phrases_desc">Haz clic en "Explicar" para ver detalles y escuchar.</p>
        <div id="phrase-list"></div>

        <div id="phrase-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal()">&times;</span>
                <h2 id="modal-es" style="color: var(--primary); margin-bottom: 10px;"></h2>
                <hr style="border: 1px solid var(--border-color);">
                <h3 id="modal-en" style="color: #666; font-weight: 400; margin-bottom: 20px;"></h3>
                <div id="modal-note" style="background: #eef; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 1.05rem;"></div>
                <div style="margin-top: 25px; text-align: center;">
                    <button class="action-btn" onclick="speakModal()" data-lang-key="btn_listen">ğŸ”Š Escuchar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÃ‘A 4: PRÃCTICA -->
    <div id="practice" class="tab-content">
        <div style="text-align: center; margin-bottom: 25px; background: var(--light-gray-bg); padding: 15px; border-radius: 12px;">
            <button class="action-btn" onclick="loadQuiz()" data-lang-key="btn_quiz">ğŸ“ Quiz (Part 1)</button>
            <button class="action-btn secondary" onclick="loadStory()" data-lang-key="btn_story">ğŸ“– Story (Part 2)</button>
            <button class="action-btn warning" onclick="loadDragDrop()" data-lang-key="btn_sorter">ğŸ¤ Sorter (Part 3)</button>
        </div>

        <div id="quiz-section" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;" data-lang-key="quiz_title">ğŸ“ Part 1: Multiple Choice</h3>
                 <button class="action-btn" onclick="generateNewQuiz()" data-lang-key="btn_new_quiz">ğŸ”„ New Quiz</button>
            </div>
            <p class="feedback" style="background: #fff3cd; color: #856404; text-align: left;" data-lang-key="quiz_note">Note: Audio reads context but not answer!</p>
            <div id="quiz-container"></div>
        </div>

        <div id="story-section" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;" data-lang-key="story_title">ğŸ“– Part 2: Complete the Story</h3>
                <button class="action-btn secondary" onclick="generateNewStory()" data-lang-key="btn_new_story">ğŸ”„ New Story</button>
            </div>
            <div class="story-text" id="story-container"></div>
            <br>
            <div style="text-align: center;">
                <button class="action-btn" onclick="checkStory()" data-lang-key="btn_check">âœ… Check Answers</button>
            </div>
        </div>

        <div id="drag-section" class="hidden">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;" data-lang-key="sorter_title">ğŸ¤ Part 3: Drag & Drop Sorter</h3>
                <button class="action-btn warning" onclick="generateNewSorter()" data-lang-key="btn_new_sorter">ğŸ”„ New Sorter</button>
            </div>
            <div class="drag-area">
                <div class="drop-zone" id="zone-que" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h3>Usa "QUE" ğŸƒ</h3>
                </div>
                <div class="drop-zone" id="zone-other" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h3>Usa "QUIEN / DONDE / LO QUE" ğŸ¯</h3>
                </div>
            </div>
            <div id="drag-items-container" style="margin-top: 30px; text-align: center; padding: 20px; background: var(--light-gray-bg); border-radius: 12px; min-height: 120px;"></div>
            <br>
             <div style="text-align: center;">
                <button class="action-btn" onclick="checkSorter()" data-lang-key="btn_check_sorter">âœ… Check Sorter</button>
            </div>
        </div>
    </div>

    <!-- PESTAÃ‘A 5: FLASHCARDS -->
    <div id="flashcards" class="tab-content">
        <div class="flashcard-container" id="flashcard-container">
            <div class="flashcard-inner" id="flashcard">
                <div class="flashcard-front">
                    <h2 id="fc-front" style="font-size: 1.8rem;">Front</h2>
                    <p style="font-size: 1rem; color: #999; margin-top: 20px;" data-lang-key="fc_tap">(Haz clic para girar ğŸ‘†)</p>
                </div>
                <div class="flashcard-back">
                    <div class="flashcard-text" id="fc-back-es">Back Spanish</div>
                    <div class="flashcard-sub" id="fc-back-en">Back English</div>
                    <div id="fc-audio-container"></div>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 30px;">
            <button class="action-btn" onclick="prevCard()" data-lang-key="btn_prev">â¬…ï¸ Anterior</button>
            <button class="action-btn" onclick="nextCard()" data-lang-key="btn_next">Siguiente â¡ï¸</button>
        </div>
    </div>

</div>

<script>
    // --- UI & TRANSLATION DATA ---
    let currentLang = 'es';
    const uiData = {
        es: {
            subtitle: "Conecta ideas con: Que, Quien, Donde, Lo que",
            tab_concept: "ğŸ§  Concepto",
            tab_formula: "ğŸ“ FÃ³rmula",
            tab_phrases: "ğŸ’¬ Frases",
            tab_practice: "ğŸ® PrÃ¡ctica",
            tab_flashcards: "âš¡ Flashcards",
            meta_title: "La MetÃ¡fora: La Etiquetadora (The Label Maker)",
            meta_desc1: "Imagina que tienes una caja genÃ©rica llamada 'El libro' (The book). ğŸ“¦",
            meta_desc2: "Una ClÃ¡usula Adjetiva es como una etiqueta adhesiva que pegas en esa caja para hacerla especÃ­fica.",
            video_title: "ğŸ“¹ Video Tutorial Interactivo",
            vis_title: "ğŸ§™â€â™‚ï¸ FÃ³rmula Visual Interactiva",
            vis_desc: "Haz clic en los botones para construir la frase y ver cÃ³mo cambia el conector.",
            vis_choose: "Elige el Antecedente:",
            formula_title: "ğŸ“ La FÃ³rmula de ConexiÃ³n",
            formula_desc: "El 'pegamento' (conector) cambia dependiendo de quÃ© estamos describiendo.",
            th_ant: "Antecedente", th_con: "Conector ğŸ”—", th_ex: "Ejemplo Completo ğŸ“",
            rule_title: "âš ï¸ Regla de Oro",
            rule_desc: "Si hay una preposiciÃ³n (a, con, de...) antes del conector y es persona, DEBES usar QUIEN.",
            phrases_title: "ğŸ’¬ Banco de Frases Ãštiles",
            phrases_desc: "Haz clic en 'Explicar' para ver detalles y escuchar.",
            btn_listen: "ğŸ”Š Escuchar",
            btn_quiz: "ğŸ“ Quiz (Parte 1)", btn_story: "ğŸ“– Historia (Parte 2)", btn_sorter: "ğŸ¤ Sorter (Parte 3)",
            quiz_title: "ğŸ“ Parte 1: OpciÃ³n MÃºltiple", btn_new_quiz: "ğŸ”„ Nuevo Quiz",
            quiz_note: "Nota: Â¡El audio lee el contexto para ayudarte!",
            story_title: "ğŸ“– Parte 2: Completa la Historia", btn_new_story: "ğŸ”„ Nueva Historia", btn_check: "âœ… Verificar",
            sorter_title: "ğŸ¤ Parte 3: Clasificador Drag & Drop", btn_new_sorter: "ğŸ”„ Nuevo Sorter", btn_check_sorter: "âœ… Verificar",
            btn_prev: "â¬…ï¸ Anterior", btn_next: "Siguiente â¡ï¸", fc_tap: "(Haz clic para girar ğŸ‘†)"
        },
        en: {
            subtitle: "Connect ideas with: Que, Quien, Donde, Lo que",
            tab_concept: "ğŸ§  Concept",
            tab_formula: "ğŸ“ Formula",
            tab_phrases: "ğŸ’¬ Phrases",
            tab_practice: "ğŸ® Practice",
            tab_flashcards: "âš¡ Flashcards",
            meta_title: "The Metaphor: The Label Maker",
            meta_desc1: "Imagine you have a generic box called 'The book'. ğŸ“¦",
            meta_desc2: "An Adjective Clause is like a sticky label you put on that box to make it specific.",
            video_title: "ğŸ“¹ Interactive Video Tutorial",
            vis_title: "ğŸ§™â€â™‚ï¸ Interactive Formula Visualizer",
            vis_desc: "Click the buttons to build the sentence and see how the connector changes.",
            vis_choose: "Choose the Antecedent:",
            formula_title: "ğŸ“ The Connection Formula",
            formula_desc: "The 'glue' (connector) changes depending on what we are describing.",
            th_ant: "Antecedent", th_con: "Connector ğŸ”—", th_ex: "Full Example ğŸ“",
            rule_title: "âš ï¸ Golden Rule",
            rule_desc: "If there is a preposition (a, con, de...) before the connector and it's a person, you MUST use QUIEN.",
            phrases_title: "ğŸ’¬ Useful Phrases Bank",
            phrases_desc: "Click 'Explain' to see details and listen.",
            btn_listen: "ğŸ”Š Listen",
            btn_quiz: "ğŸ“ Quiz (Part 1)", btn_story: "ğŸ“– Story (Part 2)", btn_sorter: "ğŸ¤ Sorter (Part 3)",
            quiz_title: "ğŸ“ Part 1: Multiple Choice", btn_new_quiz: "ğŸ”„ New Quiz",
            quiz_note: "Note: Audio reads the context to help you!",
            story_title: "ğŸ“– Part 2: Complete the Story", btn_new_story: "ğŸ”„ New Story", btn_check: "âœ… Check Answers",
            sorter_title: "ğŸ¤ Part 3: Drag & Drop Sorter", btn_new_sorter: "ğŸ”„ New Sorter", btn_check_sorter: "âœ… Check Sorter",
            btn_prev: "â¬…ï¸ Previous", btn_next: "Next â¡ï¸", fc_tap: "(Click to flip ğŸ‘†)"
        }
    };

    function toggleLang() {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if(uiData[currentLang][key]) el.innerHTML = uiData[currentLang][key];
        });
    }

    // --- VISUALIZER LOGIC (RESTAURADO) ---
    function updateVisualizer(type) {
        const ant = document.getElementById('vis-ant');
        const con = document.getElementById('vis-con');
        const cla = document.getElementById('vis-cla');

        if (type === 'persona') {
            ant.innerHTML = "La persona ğŸ‘¤";
            con.innerHTML = "+ QUIEN / QUE ğŸ”— +";
            cla.innerHTML = "me ayudÃ³ es amable. ğŸ˜Š";
        } else if (type === 'cosa') {
            ant.innerHTML = "El coche ğŸš—";
            con.innerHTML = "+ QUE ğŸ”— +";
            cla.innerHTML = "alquilÃ© es rÃ¡pido. ğŸ’¨";
        } else if (type === 'lugar') {
            ant.innerHTML = "El hotel ğŸ¨";
            con.innerHTML = "+ DONDE ğŸ”— +";
            cla.innerHTML = "nos quedamos es lujoso. âœ¨";
        }
        con.style.transform = 'scale(1.2)';
        setTimeout(() => con.style.transform = 'scale(1.1)', 300);
    }

    // --- 1. EXPANDED PHRASES (10 ITEMS) ---
    const phrasesData = [
        { es: "El libro ğŸ“˜ que estoy leyendo es fascinante.", en: "The book that I am reading is fascinating.", note: "Uso bÃ¡sico de 'que' para cosas." },
        { es: "La mujer ğŸ‘©â€ğŸ’¼ con quien hablÃ© era mi jefa.", en: "The woman with whom I spoke was my boss.", note: "'Quien' es obligatorio despuÃ©s de preposiciÃ³n." },
        { es: "Este es el restaurante ğŸ½ï¸ donde nos conocimos.", en: "This is the restaurant where we met.", note: "'Donde' para lugares fÃ­sicos o figurados." },
        { es: "No entiendo lo que ğŸ¤” dices.", en: "I don't understand what you are saying.", note: "'Lo que' para ideas abstractas." },
        { es: "Busco una persona ğŸ” que sepa cocinar.", en: "I'm looking for a person who knows how to cook.", note: "'Que' para personas sin preposiciÃ³n." },
        { es: "El estudiante cuyo ğŸ’ libro se perdiÃ³.", en: "The student whose book was lost.", note: "'Cuyo' indica posesiÃ³n (whose)." },
        { es: "La razÃ³n por la que â“ vine es secreta.", en: "The reason (why) I came is secret.", note: "Usamos 'por la que' o 'que' para razones." },
        { es: "Todo lo que âœ¨ brilla no es oro.", en: "All that glitters is not gold.", note: "'Todo lo que' es una frase fija comÃºn." },
        { es: "El aÃ±o cuando ğŸ“… nacÃ­ fue especial.", en: "The year when I was born was special.", note: "A veces usamos 'cuando' o 'en que' para tiempo." },
        { es: "Es el chico a quien ğŸ di el regalo.", en: "He is the boy to whom I gave the gift.", note: "PreposiciÃ³n 'a' + quien (objeto indirecto)." }
    ];

    // --- 2. DATA: QUIZ (20 ITEMS) ---
    const quizData = [
        { q: "El chico ğŸ‘¦ ___ vive allÃ­ es mi amigo.", options: ["que", "quien", "donde"], a: "que", audio: "El chico que vive allÃ­ es mi amigo." },
        { q: "La chica ğŸ‘§ con ___ fui al cine es Ana.", options: ["quien", "que", "donde"], a: "quien", audio: "La chica con quien fui al cine es Ana." },
        { q: "La ciudad ğŸ™ï¸ ___ nacÃ­ es hermosa.", options: ["donde", "que", "quien"], a: "donde", audio: "La ciudad donde nacÃ­ es hermosa." },
        { q: "Eso es exactamente ___ ğŸ’¡ yo pensaba.", options: ["lo que", "que", "donde"], a: "lo que", audio: "Eso es exactamente lo que yo pensaba." },
        { q: "El coche ğŸš— ___ alquilamos es nuevo.", options: ["que", "quien", "donde"], a: "que", audio: "El coche que alquilamos es nuevo." },
        { q: "Los estudiantes ğŸ“ a ___ enseÃ±o son aplicados.", options: ["quienes", "que", "donde"], a: "quienes", audio: "Los estudiantes a quienes enseÃ±o son aplicados." },
        { q: "El parque ğŸŒ³ ___ jugamos de niÃ±os ya no existe.", options: ["donde", "que", "quien"], a: "donde", audio: "El parque donde jugamos de niÃ±os ya no existe." },
        { q: "La novela ğŸ“– ___ me prestaste es muy larga.", options: ["que", "quien", "donde"], a: "que", audio: "La novela que me prestaste es muy larga." },
        { q: "El hombre ğŸ‘¨â€ğŸ¦³ de ___ te hablÃ© es mi tÃ­o.", options: ["quien", "que", "donde"], a: "quien", audio: "El hombre de quien te hablÃ© es mi tÃ­o." },
        { q: "No escuchÃ© ___ ğŸ‘‚ dijiste.", options: ["lo que", "que", "donde"], a: "lo que", audio: "No escuchÃ© lo que dijiste." },
        { q: "La casa ğŸ¡ ___ compramos tiene jardÃ­n.", options: ["que", "donde", "quien"], a: "que", audio: "La casa que compramos tiene jardÃ­n." },
        { q: "La razÃ³n â“ por la ___ vine es secreta.", options: ["que", "quien", "donde"], a: "que", audio: "La razÃ³n por la que vine es secreta." },
        { q: "El mÃ©dico ğŸ‘¨â€âš•ï¸ ___ me atendiÃ³ fue amable.", options: ["que", "quien", "donde"], a: "que", audio: "El mÃ©dico que me atendiÃ³ fue amable." },
        { q: "El hotel ğŸ¨ ___ nos quedamos era caro.", options: ["donde", "que", "quien"], a: "donde", audio: "El hotel donde nos quedamos era caro." },
        { q: "Todo ___ âœ¨ brilla no es oro.", options: ["lo que", "que", "donde"], a: "lo que", audio: "Todo lo que brilla no es oro." },
        { q: "Las amigas ğŸ‘¯â€â™€ï¸ con ___ salgo son divertidas.", options: ["quienes", "que", "donde"], a: "quienes", audio: "Las amigas con quienes salgo son divertidas." },
        { q: "El perro ğŸ• ___ ladra no muerde.", options: ["que", "quien", "donde"], a: "que", audio: "El perro que ladra no muerde." },
        { q: "El museo ğŸ›ï¸ ___ visitamos era enorme.", options: ["que", "donde", "quien"], a: "que", audio: "El museo que visitamos era enorme." },
        { q: "Ese es el lugar ğŸ“ ___ perdÃ­ mis llaves.", options: ["donde", "que", "quien"], a: "donde", audio: "Ese es el lugar donde perdÃ­ mis llaves." },
        { q: "Haz ___ ğŸ‘ quieras.", options: ["lo que", "que", "donde"], a: "lo que", audio: "Haz lo que quieras." }
    ];

    // --- 3. DATA: STORIES (10 STORIES) ---
    const storiesData = [
        `<strong>Historia 1: El Restaurante</strong><br>
        Ayer fui a un restaurante ğŸ½ï¸ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> me recomendaste hace tiempo. 
        El camarero ğŸ‘¨â€ğŸ³ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> nos atendiÃ³ fue increÃ­blemente amable y rÃ¡pido. 
        Era el lugar exacto <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="lo que">lo que</option></select> hacen la mejor paella de la ciudad. 
        Al principio, no sabÃ­a <select class="story-input" data-ans="lo que"><option value="">___</option><option value="lo que">lo que</option><option value="que">que</option></select> pedir porque todo olÃ­a delicioso.
        Finalmente, mi amiga, con <select class="story-input" data-ans="quien"><option value="">___</option><option value="quien">quien</option><option value="que">que</option></select> fui a cenar, eligiÃ³ el postre por mÃ­.`,
        
        `<strong>Historia 2: El Cine</strong><br>
        La pelÃ­cula ğŸ¬ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> vimos anoche fue terrible.
        El cine ğŸ¿ <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="quien">quien</option></select> estÃ¡bamos hacÃ­a mucho frÃ­o y no funcionaba la calefacciÃ³n.
        <select class="story-input" data-ans="Lo que"><option value="">___</option><option value="Lo que">Lo que</option><option value="Que">Que</option></select> mÃ¡s me molestÃ³ fue el final inesperado y absurdo.
        Los actores ğŸ­ a <select class="story-input" data-ans="quienes"><option value="">___</option><option value="quienes">quienes</option><option value="que">que</option></select> admiro normalmente, actuaron muy mal en esta ocasiÃ³n.
        Fue una experiencia <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> prefiero olvidar pronto.`,

        `<strong>Historia 3: La Escuela</strong><br>
        La escuela ğŸ« <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> estudiÃ© primaria era un edificio muy antiguo y bonito.
        Los profesores ğŸ‘¨â€ğŸ« a <select class="story-input" data-ans="quienes"><option value="">___</option><option value="quienes">quienes</option><option value="que">que</option></select> recuerdo con cariÃ±o me enseÃ±aron a leer y escribir.
        Es una Ã©poca <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> nunca olvidarÃ©, llena de juegos y risas.
        AÃºn conservo los libros ğŸ“š <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> usÃ¡bamos en clase de historia.
        <select class="story-input" data-ans="Lo que"><option value="">___</option><option value="Lo que">Lo que</option><option value="Que">Que</option></select> mÃ¡s extraÃ±o son los recreos interminables con mis amigos.`,

        `<strong>Historia 4: El Viaje</strong><br>
        El viaje âœˆï¸ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> hicimos a PerÃº fue simplemente mÃ¡gico e inolvidable.
        El guÃ­a turÃ­stico con <select class="story-input" data-ans="quien"><option value="">___</option><option value="quien">quien</option><option value="que">que</option></select> anduvimos sabÃ­a mucho sobre los Incas.
        Vimos paisajes y montaÃ±as <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="lo que">lo que</option></select> nunca imaginÃ© que existieran.
        El hotel <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> dormimos tenÃ­a vistas a las ruinas antiguas.
        Todo <select class="story-input" data-ans="lo que"><option value="">___</option><option value="lo que">lo que</option><option value="que">que</option></select> comimos allÃ­ estaba delicioso y picante.`,

        `<strong>Historia 5: La Fiesta</strong><br>
        Realmente no sÃ© <select class="story-input" data-ans="lo que"><option value="">___</option><option value="lo que">lo que</option><option value="que">que</option></select> pasÃ³ exactamente en la fiesta ğŸ‰ de anoche.
        La casa <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> se celebrÃ³ el evento era enorme y tenÃ­a piscina.
        La mÃºsica ğŸµ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> puso el DJ era genial y todos bailaron.
        ConocÃ­ a una chica <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> bailaba salsa increÃ­blemente bien.
        Fue una noche <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> recordaremos por mucho tiempo.`,

        `<strong>Historia 6: Mi Hermano</strong><br>
        Mi hermano mayor ğŸ‘¦, <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> vive en Madrid desde hace aÃ±os, vino ayer de visita.
        Trajo un regalo especial ğŸ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="lo que">lo que</option></select> me encantÃ³ y me hizo llorar.
        Es alguien con <select class="story-input" data-ans="quien"><option value="">___</option><option value="quien">quien</option><option value="que">que</option></select> siempre me divierto mucho cuando estamos juntos.
        Fuimos al parque <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> jugÃ¡bamos de pequeÃ±os.
        <select class="story-input" data-ans="Lo que"><option value="">___</option><option value="Lo que">Lo que</option><option value="Que">Que</option></select> mÃ¡s me gusta es escuchar sus historias de viajes.`,

        `<strong>Historia 7: El Trabajo</strong><br>
        El trabajo ğŸ’¼ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> tengo ahora es bastante difÃ­cil y estresante.
        La oficina <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="lo que">lo que</option></select> paso ocho horas al dÃ­a queda muy lejos de mi casa.
        <select class="story-input" data-ans="Lo que"><option value="">___</option><option value="Lo que">Lo que</option><option value="Que">Que</option></select> mÃ¡s me gusta, sin embargo, son mis compaÃ±eros de equipo.
        El jefe para <select class="story-input" data-ans="quien"><option value="">___</option><option value="quien">quien</option><option value="que">que</option></select> trabajo es exigente pero justo.
        Es una oportunidad <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> debo aprovechar para mi carrera.`,

        `<strong>Historia 8: El Coche Nuevo</strong><br>
        Por fin comprÃ© un coche ğŸš— <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> es muy rÃ¡pido y de color rojo brillante.
        El vendedor a <select class="story-input" data-ans="quien"><option value="">___</option><option value="quien">quien</option><option value="que">que</option></select> se lo comprÃ© fue muy honesto con el precio.
        Es el coche <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> siempre quise tener desde que era niÃ±o.
        El garaje <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> lo guardo es seguro y amplio.
        No sabes <select class="story-input" data-ans="lo que"><option value="">___</option><option value="lo que">lo que</option><option value="que">que</option></select> disfruto conduciendo por la carretera.`,

        `<strong>Historia 9: Mi Ciudad Natal</strong><br>
        La ciudad ğŸ™ï¸ <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> nacÃ­ ha cambiado mucho en los Ãºltimos diez aÃ±os.
        Las calles por las <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quienes">quienes</option></select> caminaba ahora estÃ¡n llenas de tiendas modernas.
        Pero la gente <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> vive allÃ­ sigue siendo igual de amable y acogedora.
        Hay un nuevo parque <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="quien">quien</option></select> los niÃ±os juegan felices.
        <select class="story-input" data-ans="Lo que"><option value="">___</option><option value="Lo que">Lo que</option><option value="Que">Que</option></select> mÃ¡s extraÃ±o es la comida tradicional de mi abuela.`,

        `<strong>Historia 10: El Libro Misterioso</strong><br>
        No entiendo <select class="story-input" data-ans="lo que"><option value="">___</option><option value="lo que">lo que</option><option value="que">que</option></select> dice este libro ğŸ“š antiguo en el primer capÃ­tulo.
        El autor, <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> es muy famoso en su paÃ­s, escribe de forma rara.
        Es un tema del <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> no sÃ© absolutamente nada.
        La biblioteca <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> lo encontrÃ© es un lugar silencioso y mÃ¡gico.
        Es una historia <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> te atrapa desde la primera pÃ¡gina.`
    ];

    // --- 4. DATA: SORTER (60 ITEMS) ---
    const dragData = [
        { text: "El libro ğŸ“˜ ___ leÃ­.", type: "que", audio: "El libro que leÃ­." },
        { text: "La pizza ğŸ• ___ comÃ­.", type: "que", audio: "La pizza que comÃ­." },
        { text: "La chica con ___ ğŸ’ƒ bailÃ©.", type: "other", audio: "La chica con quien bailÃ©." },
        { text: "El parque ___ ğŸŒ³ corro.", type: "other", audio: "El parque donde corro." },
        { text: "___ ğŸ¤” piensas.", type: "other", audio: "Lo que piensas." },
        // ... (Agregando los 60 items completos)
        { text: "El paÃ­s ğŸŒ ___ visitÃ©.", type: "que", audio: "El paÃ­s que visitÃ©." },
        { text: "La casa ğŸ  ___ comprÃ©.", type: "que", audio: "La casa que comprÃ©." },
        { text: "El jefe de ___ ğŸ‘” dependo.", type: "other", audio: "El jefe de quien dependo." },
        { text: "La canciÃ³n ğŸµ ___ escucho.", type: "que", audio: "La canciÃ³n que escucho." },
        { text: "El regalo ğŸ ___ me diste.", type: "que", audio: "El regalo que me diste." },
        { text: "La carta âœ‰ï¸ ___ escribÃ­.", type: "que", audio: "La carta que escribÃ­." },
        { text: "El coche ğŸš— ___ alquilÃ©.", type: "que", audio: "El coche que alquilÃ©." },
        { text: "La flor ğŸŒ¸ ___ huele bien.", type: "que", audio: "La flor que huele bien." },
        { text: "El agua ğŸ’§ ___ bebo.", type: "que", audio: "El agua que bebo." },
        { text: "La mesa ğŸª‘ ___ rompÃ­.", type: "que", audio: "La mesa que rompÃ­." },
        { text: "El chico ğŸ‘¦ ___ corre.", type: "que", audio: "El chico que corre." },
        { text: "La mujer ğŸ‘© ___ canta.", type: "que", audio: "La mujer que canta." },
        { text: "El gato ğŸˆ ___ duerme.", type: "que", audio: "El gato que duerme." },
        { text: "La llave ğŸ”‘ ___ perdÃ­.", type: "que", audio: "La llave que perdÃ­." },
        { text: "El telÃ©fono ğŸ“± ___ suena.", type: "que", audio: "El telÃ©fono que suena." },
        { text: "La ropa ğŸ‘— ___ uso.", type: "que", audio: "La ropa que uso." },
        { text: "El juego ğŸ® ___ juego.", type: "que", audio: "El juego que juego." },
        { text: "La foto ğŸ–¼ï¸ ___ mirÃ©.", type: "que", audio: "La foto que mirÃ©." },
        { text: "El video ğŸ“¹ ___ grabÃ©.", type: "que", audio: "El video que grabÃ©." },
        { text: "El dinero ğŸ’° ___ ganÃ©.", type: "que", audio: "El dinero que ganÃ©." },
        { text: "La luz ğŸ’¡ ___ brilla.", type: "que", audio: "La luz que brilla." },
        { text: "El pan ğŸ¥– ___ horneÃ©.", type: "que", audio: "El pan que horneÃ©." },
        { text: "El hombre a ___ ğŸ¤ saludÃ©.", type: "other", audio: "El hombre a quien saludÃ©." },
        { text: "Los amigos con ___ ğŸ—£ï¸ hablo.", type: "other", audio: "Los amigos con quienes hablo." },
        { text: "La madre para ___ ğŸ comprÃ© esto.", type: "other", audio: "La madre para quien comprÃ© esto." },
        { text: "El cine ___ ğŸ¿ fuimos.", type: "other", audio: "El cine donde fuimos." },
        { text: "El hotel ___ ğŸ¨ dormÃ­.", type: "other", audio: "El hotel donde dormÃ­." },
        { text: "El bar ___ ğŸ» bebimos.", type: "other", audio: "El bar donde bebimos." },
        { text: "La escuela ___ ğŸ« estudio.", type: "other", audio: "La escuela donde estudio." },
        { text: "___ â¤ï¸ sientes.", type: "other", audio: "Lo que sientes." },
        { text: "___ ğŸ‘‚ escuchas.", type: "other", audio: "Lo que escuchas." },
        { text: "___ ğŸ‘€ ves.", type: "other", audio: "Lo que ves." },
        { text: "___ ğŸ¤·â€â™‚ï¸ pasa.", type: "other", audio: "Lo que pasa." },
        { text: "___ ğŸ—£ï¸ dijiste.", type: "other", audio: "Lo que dijiste." },
        { text: "La playa ___ ğŸ–ï¸ nado.", type: "other", audio: "La playa donde nado." },
        { text: "El alumno a ___ ğŸ“ enseÃ±o.", type: "other", audio: "El alumno a quien enseÃ±o." },
        { text: "La tÃ­a con ___ â˜• meriendo.", type: "other", audio: "La tÃ­a con quien meriendo." },
        { text: "El hospital ___ ğŸ¥ trabajo.", type: "other", audio: "El hospital donde trabajo." },
        { text: "___ ğŸ› ï¸ haces.", type: "other", audio: "Lo que haces." },
        { text: "___ âœ¨ importa.", type: "other", audio: "Lo que importa." },
        { text: "El jardÃ­n ___ ğŸŒ· descanso.", type: "other", audio: "El jardÃ­n donde descanso." },
        { text: "La persona de ___ ğŸ’­ pienso.", type: "other", audio: "La persona de quien pienso." },
        { text: "___ ğŸ›‘ prohiben.", type: "other", audio: "Lo que prohiben." }
    ];

    // --- 5. DATA: FLASHCARDS ---
    const flashcardsData = [
        { en: "The book ğŸ“˜ that I bought", es: "El libro que comprÃ©" },
        { en: "The girl ğŸ‘§ with whom I study", es: "La chica con quien estudio" },
        { en: "The place ğŸ  where we eat", es: "El lugar donde comemos" },
        { en: "What ğŸ’¡ (that which) you want", es: "Lo que quieres" },
        { en: "The people ğŸ‘¥ who help me", es: "Las personas que me ayudan" },
        { en: "A house ğŸ¡ that has a pool", es: "Una casa que tenga piscina" }
    ];

    // --- LOGIC ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll(`.tab-btn[onclick*="${tabId}"]`).forEach(b => b.classList.add('active'));
    }

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    function speak(text) {
        window.speechSynthesis.cancel();
        // Filtrar emojis para evitar redundancia
        const cleanText = text.replace(/\p{Emoji_Presentation}/gu, '').trim();
        const u = new SpeechSynthesisUtterance(cleanText);
        u.lang = 'es-ES'; u.rate = 0.9;
        const v = window.speechSynthesis.getVoices().find(v => (v.name.includes('Google') || v.name.includes('Monica')) && v.lang.includes('es'));
        if(v) u.voice = v;
        window.speechSynthesis.speak(u);
    }

    // Modal
    const phraseList = document.getElementById('phrase-list');
    phrasesData.forEach(p => {
        let div = document.createElement('div');
        div.className = 'phrase-item';
        div.innerHTML = `<span style="font-size: 1.1rem;">${p.es}</span> <button class="action-btn explain-btn">Explicar ğŸ’¡</button>`;
        div.querySelector('.explain-btn').addEventListener('click', (e) => { e.stopPropagation(); openModal(p); });
        phraseList.appendChild(div);
    });
    let currentModalText = "";
    function openModal(data) {
        document.getElementById('modal-es').innerText = data.es;
        document.getElementById('modal-en').innerText = data.en;
        document.getElementById('modal-note').innerHTML = "<strong>ğŸ’¡ ExplicaciÃ³n:</strong> " + data.note;
        currentModalText = data.es;
        document.getElementById('phrase-modal').classList.add('active');
    }
    function closeModal() { document.getElementById('phrase-modal').classList.remove('active'); }
    function speakModal() { speak(currentModalText); }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Activities
    function loadQuiz() {
        document.getElementById('quiz-section').classList.remove('hidden');
        document.getElementById('story-section').classList.add('hidden');
        document.getElementById('drag-section').classList.add('hidden');
        if(document.getElementById('quiz-container').innerHTML === "") generateNewQuiz();
    }
    function generateNewQuiz() {
        const c = document.getElementById('quiz-container'); c.innerHTML = '';
        shuffleArray([...quizData]).slice(0, 5).forEach((item, i) => {
            let div = document.createElement('div'); div.className = 'quiz-question';
            let html = `<p><strong>${i+1}.</strong> ${item.q} <span class="tts-icon" onclick="speak('${item.audio}')" style="font-size:1.2rem">ğŸ”Š</span></p><div class="options-grid">`;
            shuffleArray([...item.options]).forEach(opt => html += `<button class="option-btn" onclick="checkQuiz(this, '${opt}', '${item.a}')">${opt}</button>`);
            div.innerHTML = html + `</div><p class="feedback hidden"></p>`;
            c.appendChild(div);
        });
    }
    function checkQuiz(btn, sel, cor) {
        const p = btn.closest('.quiz-question');
        const f = p.querySelector('.feedback');
        p.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
        if(sel === cor) { btn.classList.add('correct'); f.style.background='#d4edda'; f.style.color='#155724'; f.innerText="Correcto! ğŸ‰"; }
        else { btn.classList.add('incorrect'); f.style.background='#f8d7da'; f.style.color='#721c24'; f.innerText=`Incorrecto. Respuesta: ${cor}`; }
        f.classList.remove('hidden');
    }

    function loadStory() {
        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('story-section').classList.remove('hidden');
        document.getElementById('drag-section').classList.add('hidden');
        if(document.getElementById('story-container').innerHTML === "") generateNewStory();
    }
    function generateNewStory() {
        document.getElementById('story-container').innerHTML = storiesData[Math.floor(Math.random() * storiesData.length)];
    }
    function checkStory() {
        const inp = document.querySelectorAll('.story-input');
        let allOk = true;
        inp.forEach(i => { if(i.value === i.dataset.ans) i.className='story-input correct'; else { i.className='story-input incorrect'; allOk=false; }});
        if(allOk && inp.length > 0) speak("Â¡Excelente trabajo!");
    }

    let draggedItem = null;
    function loadDragDrop() {
        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('story-section').classList.add('hidden');
        document.getElementById('drag-section').classList.remove('hidden');
        if(document.getElementById('drag-items-container').innerHTML === "") generateNewSorter();
    }
    function generateNewSorter() {
        const c = document.getElementById('drag-items-container'); c.innerHTML = '';
        document.querySelectorAll('.drop-zone').forEach(z => { 
            const h = z.querySelector('h3'); z.innerHTML=''; z.appendChild(h); z.classList.remove('drag-over'); 
        });
        shuffleArray([...dragData]).slice(0, 8).forEach(item => {
            let el = document.createElement('div'); el.className = 'drag-item'; el.draggable = true;
            el.innerHTML = `<span>${item.text}</span> <span class="tts-icon" onclick="event.stopPropagation(); speak('${item.audio}')">ğŸ”Š</span>`;
            el.dataset.type = item.type;
            el.addEventListener('dragstart', function() { draggedItem = this; setTimeout(()=>this.style.opacity='0.5',0); });
            el.addEventListener('dragend', function() { this.style.opacity='1'; draggedItem=null; document.querySelectorAll('.drop-zone').forEach(z=>z.classList.remove('drag-over')); });
            el.addEventListener('touchstart', handleTouchStart, {passive:false});
            el.addEventListener('touchmove', handleTouchMove, {passive:false});
            el.addEventListener('touchend', handleTouchEnd);
            c.appendChild(el);
        });
    }
    
    // iPad Touch
    let tEl=null, tX=0, tY=0;
    function handleTouchStart(e) { if(e.target.classList.contains('tts-icon')) return; tEl=e.currentTarget; const t=e.targetTouches[0]; const r=tEl.getBoundingClientRect(); tX=t.clientX-r.left; tY=t.clientY-r.top; tEl.style.position='fixed'; tEl.style.zIndex=1000; tEl.style.width=r.width+'px'; tEl.style.left=(t.clientX-tX)+'px'; tEl.style.top=(t.clientY-tY)+'px'; document.body.appendChild(tEl); e.preventDefault(); }
    function handleTouchMove(e) { if(!tEl)return; const t=e.targetTouches[0]; tEl.style.left=(t.clientX-tX)+'px'; tEl.style.top=(t.clientY-tY)+'px'; e.preventDefault(); }
    function handleTouchEnd(e) { if(!tEl)return; tEl.style.display='none'; let el=document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY); tEl.style.display='inline-flex'; let zone=el?el.closest('.drop-zone'):null; tEl.style.position=''; tEl.style.zIndex=''; tEl.style.width=''; if(zone) zone.appendChild(tEl); else document.getElementById('drag-items-container').appendChild(tEl); tEl=null; }
    
    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
    function drop(e) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); if(draggedItem) e.currentTarget.appendChild(draggedItem); }
    function checkSorter() {
        let sc=0, tot=0;
        ['zone-que','zone-other'].forEach(id => {
            let type = id==='zone-que'?'que':'other';
            document.getElementById(id).querySelectorAll('.drag-item').forEach(i => { tot++; if(i.dataset.type===type){i.style.backgroundColor='var(--green)'; sc++;} else i.style.backgroundColor='var(--red)'; });
        });
        if(tot>0 && sc===tot) speak("Â¡Perfecto!");
    }

    // Flashcards
    let fcIdx = 0;
    function updateCard() {
        document.getElementById('flashcard-container').classList.remove('is-flipped');
        setTimeout(() => {
            let d = flashcardsData[fcIdx];
            document.getElementById('fc-front').innerText = d.en;
            document.getElementById('fc-back-es').innerText = d.es;
            document.getElementById('fc-back-en').innerText = d.en;
            let ac = document.getElementById('fc-audio-container'); ac.innerHTML='';
            let icon = document.createElement('span'); icon.className='tts-icon'; icon.innerText='ğŸ”Š';
            icon.onclick=(e)=>{e.stopPropagation(); speak(d.es);}; ac.appendChild(icon);
        }, 200);
    }
    document.getElementById('flashcard').onclick=(e)=>{ if(!e.target.classList.contains('tts-icon')) document.getElementById('flashcard-container').classList.toggle('is-flipped'); };
    function nextCard() { fcIdx=(fcIdx+1)%flashcardsData.length; updateCard(); }
    function prevCard() { fcIdx=(fcIdx-1+flashcardsData.length)%flashcardsData.length; updateCard(); }

    window.speechSynthesis.getVoices();
    updateCard();
    updateVisualizer('persona'); // Init visualizer
</script>
</body>
</html>
