<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adjective Clauses Master ğŸ·ï¸</title>
    
    <style>
        :root {
            /* --- PALETA MAESTRA --- */
            --primary: #007bff;       /* Azul Principal */
            --dark-blue: #0056b3;     /* Azul Oscuro */
            --green: #28a745;         /* Verde Ã‰xito */
            --red: #dc3545;           /* Rojo Error */
            --yellow: #ffc107;        /* Amarillo Alerta */
            --orange: #fd7e14;        /* Naranja Destacados */
            
            /* Variables de Tema */
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* MODO OSCURO */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --tab-bg: #333;
            --tab-active-bg: #bb86fc;
            --tab-text: #aaa;
            --tab-active-text: #000;
            --border-color: #444;
            --light-gray-bg: #2c2c2c;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; }
        
        .main-container { max-width: 950px; margin: 0 auto; background: var(--container-bg); border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        
        /* HEADER */
        header { background: var(--header-bg); color: white; padding: 25px 20px; text-align: center; position: relative; }
        header h1 { margin: 10px 0 5px; font-size: 2rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        header p { margin: 5px 0 0; opacity: 0.95; font-size: 1.1rem; }
        
        /* BOTONES SUPERIORES */
        .top-btn { position: absolute; top: 15px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 1rem; transition: all 0.2s; font-weight: bold; }
        .top-btn:hover { background: rgba(255,255,255,0.4); transform: scale(1.05); }
        .lang-btn { left: 15px; }
        .theme-btn { right: 15px; }

        /* TABS */
        .tab-nav { display: flex; background: var(--tab-bg); overflow-x: auto; -webkit-overflow-scrolling: touch; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-size: 1rem; color: var(--tab-text); border-bottom: 4px solid transparent; font-weight: 600; white-space: nowrap; transition: all 0.2s; min-width: 100px; }
        .tab-btn.active { background: var(--tab-active-bg); color: var(--tab-active-text); border-bottom-color: var(--yellow); }
        
        .tab-content { display: none; padding: 25px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .action-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; margin: 5px; box-shadow: var(--shadow); transition: transform 0.1s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .action-btn.secondary { background: var(--green); }
        .action-btn.warning { background: var(--yellow); color: #333; }
        .action-btn.orange { background: var(--orange); color: white; }
        .explain-btn { padding: 5px 12px; font-size: 0.85rem; border-radius: 20px; background: var(--dark-blue); }

        .metaphor-box { text-align: center; padding: 30px; background: var(--light-gray-bg); border-radius: 12px; border: 2px dashed var(--border-color); margin-bottom: 30px; }
        .metaphor-title { color: var(--primary); margin-bottom: 20px; font-size: 1.5rem; }
        .emoji-large { font-size: 4rem; display: block; animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; margin: 30px 0; box-shadow: var(--shadow); background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        /* VISUALIZADOR DE FÃ“RMULA */
        .formula-visualizer { background: var(--container-bg); padding: 20px; border-radius: 12px; border: 2px solid var(--primary); margin-top: 30px; text-align: center; }
        .visualizer-display { font-size: 1.3rem; margin: 20px 0; padding: 15px; background: var(--light-gray-bg); border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; align-items: center; }
        .vis-part { padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
        .vis-antecedent { background: #e3f2fd; color: var(--primary); border: 1px solid #b3d7ff; }
        .vis-connector { background: #fff3cd; color: #856404; font-weight: bold; border: 1px solid #ffeeba; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .vis-clause { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .vis-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }

        .grammar-table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 20px 0; background: var(--container-bg); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .grammar-table th, .grammar-table td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        .grammar-table th { background: rgba(0,123,255,0.08); color: var(--primary); font-weight: bold; text-transform: uppercase; font-size: 0.9rem; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--container-bg); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3); animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #999; }
        .phrase-item { background: var(--light-gray-bg); padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }

        /* FLASHCARDS */
        .flashcard-container { perspective: 1000px; width: 100%; max-width: 500px; height: 320px; margin: 20px auto; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .flashcard-container.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; border-radius: 15px; background: var(--container-bg); border: 1px solid var(--border-color); }
        .flashcard-back { transform: rotateY(180deg); background: #fffcf5; }
        body.dark-mode .flashcard-back { background: #2a2a2a; }
        .tts-icon { font-size: 2rem; margin-top: 20px; cursor: pointer; display: inline-block; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }

        /* PRACTICE */
        .quiz-question { background: var(--light-gray-bg); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 6px solid var(--yellow); }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
        @media (min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }
        .option-btn { background: var(--container-bg); border: 2px solid var(--border-color); padding: 15px; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s; display: flex; align-items: center; }
        .option-btn.correct { background: #d4edda !important; border-color: #28a745 !important; color: #155724; font-weight: bold; }
        .option-btn.incorrect { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24; opacity: 0.8; }
        
        .story-text { line-height: 2.4; font-size: 1.15rem; background: var(--light-gray-bg); padding: 25px; border-radius: 12px; border: 2px solid var(--border-color); }
        select.story-input { border: 2px solid var(--primary); padding: 5px; border-radius: 6px; font-size: 1rem; background: var(--container-bg); color: var(--text-color); }
        select.story-input.correct { border-color: var(--green); background: #d4edda; color: #155724; }
        select.story-input.incorrect { border-color: var(--red); background: #f8d7da; color: #721c24; }

        /* DRAG DROP */
        .drag-area { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 25px; }
        .drop-zone { flex: 1; min-width: 300px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 15px; padding: 20px; min-height: 300px; display: flex; flex-direction: column; align-items: center; }
        .drop-zone.drag-over { background: rgba(0,123,255,0.1); border-color: var(--primary); transform: scale(1.02); }
        .drag-item { background: var(--primary); color: white; padding: 12px 20px; margin: 8px; border-radius: 50px; display: inline-flex; align-items: center; cursor: grab; touch-action: none; z-index: 10; }
        .drag-item:active { cursor: grabbing; transform: scale(1.1); }

        .hidden { display: none; }
        .feedback { margin-top: 10px; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div class="main-container">
    <header>
        <h1>Adjective Clauses Master ğŸ·ï¸</h1>
        <p data-lang-key="subtitle">Conecta ideas con: Que, Quien, Donde, Lo que</p>
        
        <button class="top-btn lang-btn" onclick="toggleLang()">ğŸŒ ES/EN</button>
        <button class="top-btn theme-btn" onclick="toggleTheme()">ğŸŒ“</button>
    </header>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('metaphor')" data-lang-key="tab_concept">ğŸ§  Concepto</button>
        <button class="tab-btn" onclick="openTab('formula')" data-lang-key="tab_formula">ğŸ“ FÃ³rmula</button>
        <button class="tab-btn" onclick="openTab('phrases')" data-lang-key="tab_phrases">ğŸ’¬ Frases</button>
        <button class="tab-btn" onclick="openTab('practice')" data-lang-key="tab_practice">ğŸ® PrÃ¡ctica</button>
        <button class="tab-btn" onclick="openTab('flashcards')" data-lang-key="tab_flashcards">âš¡ Flashcards</button>
    </div>

    <div id="metaphor" class="tab-content active">
        <div class="metaphor-box">
            <h2 class="metaphor-title" data-lang-key="meta_title">La MetÃ¡fora: La Etiquetadora (The Label Maker)</h2>
            <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 25px;">
                <span class="emoji-large">ğŸ“¦</span><span class="emoji-large">ğŸ·ï¸</span><span class="emoji-large">âœ¨</span>
            </div>
            <p data-lang-key="meta_desc1">Imagina que tienes una caja genÃ©rica llamada "El libro" (The book). ğŸ“¦</p>
            <p data-lang-key="meta_desc2">Una <strong style="color:var(--primary)">ClÃ¡usula Adjetiva</strong> es como una <strong style="color:var(--orange)">etiqueta adhesiva</strong> que pegas en esa caja para hacerla especÃ­fica.</p>
        </div>

        <h3 style="color: var(--primary); text-align: center;" data-lang-key="video_title">ğŸ“¹ Video Tutorial Interactivo</h3>
        <div class="video-container">
            <iframe src="https://drive.google.com/file/d/1GvLKweVVyGK7NV56g-Lo3DvjSXqjQwW2/preview" allow="autoplay"></iframe>
        </div>

        <div class="formula-visualizer">
            <h3 style="color: var(--primary); margin-top: 0;" data-lang-key="vis_title">ğŸ§™â€â™‚ï¸ FÃ³rmula Visual Interactiva</h3>
            <p data-lang-key="vis_desc">Haz clic en los botones para construir la frase y ver cÃ³mo cambia el conector.</p>
            
            <div class="visualizer-display">
                <span id="vis-ant" class="vis-part vis-antecedent">La persona ğŸ‘¤</span>
                <span id="vis-con" class="vis-part vis-connector">+ QUIEN ğŸ”— +</span>
                <span id="vis-cla" class="vis-part vis-clause">me ayudÃ³ es amable. ğŸ˜Š</span>
            </div>

            <div class="vis-controls">
                <p><strong data-lang-key="vis_choose">Elige el Antecedente:</strong></p>
                <button class="action-btn secondary" onclick="updateVisualizer('persona')">ğŸ‘¤ Persona</button>
                <button class="action-btn secondary" onclick="updateVisualizer('cosa')">ğŸš— Cosa/Animal</button>
                <button class="action-btn secondary" onclick="updateVisualizer('lugar')">ğŸ™ï¸ Lugar</button>
            </div>
        </div>

        <hr style="border: 0; border-top: 3px dashed var(--orange); margin: 50px 0;">
        <div class="metaphor-box" style="border-color: var(--orange); background: rgba(253, 126, 20, 0.05);">
            <h2 class="metaphor-title" style="color: var(--orange);" data-lang-key="meta_lvl2_title">âš“ NIVEL 2: La MetÃ¡fora del Ancla</h2>
            <p data-lang-key="meta_lvl2_desc">Cuando usas preposiciones (<em>en, con, a, de</em>), el "QUE" es dÃ©bil. Necesitas un <strong>ANCLA</strong> (el, la, los, las) para sostenerlo.</p>
            
            <div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-top: 25px; font-size: 1.2rem;">
                <div style="background: var(--container-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow);">ğŸ  La casa</div>
                <div style="font-weight: bold; color: var(--orange);">+ EN</div>
                <div style="background: var(--orange); color: white; padding: 10px; border-radius: 8px; font-weight: bold; transform: rotate(-5deg); box-shadow: var(--shadow);">LA (Ancla)</div>
                <div style="font-weight: bold;">+ QUE</div>
                <div>vivo.</div>
            </div>
            <p style="margin-top: 20px; font-weight: bold; color: var(--dark-blue);">Resultado: La casa EN LA QUE vivo.</p>
        </div>
    </div>

    <div id="formula" class="tab-content">
        <h3 data-lang-key="formula_title">ğŸ“ La FÃ³rmula de ConexiÃ³n</h3>
        <p data-lang-key="formula_desc">El "pegamento" (conector) cambia dependiendo de quÃ© estamos describiendo.</p>
        
        <table class="grammar-table">
            <thead>
                <tr>
                    <th data-lang-key="th_ant">Antecedente</th>
                    <th data-lang-key="th_con">Conector ğŸ”—</th>
                    <th data-lang-key="th_ex">Ejemplo Completo ğŸ“</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Personas/Cosas</strong></td>
                    <td><strong>que</strong></td>
                    <td>El libro ğŸ“˜ <strong>que</strong> leÃ­.</td>
                </tr>
                <tr>
                    <td><strong>Personas (Prep.)</strong></td>
                    <td><strong>quien</strong></td>
                    <td>La mujer ğŸ‘© <strong>con quien</strong> hablÃ©.</td>
                </tr>
                <tr>
                    <td><strong>Lugares</strong></td>
                    <td><strong>donde</strong></td>
                    <td>El parque ğŸŒ³ <strong>donde</strong> jugamos.</td>
                </tr>
                 <tr>
                    <td><strong>Ideas (Abstract)</strong></td>
                    <td><strong>lo que</strong></td>
                    <td>No sÃ© ğŸ¤” <strong>lo que</strong> quieres.</td>
                </tr>
            </tbody>
        </table>

        <div style="background: var(--light-gray-bg); padding: 20px; border-radius: 12px; margin-top: 30px; border-left: 5px solid var(--yellow);">
            <h4 style="margin-top: 0;" data-lang-key="rule_title">âš ï¸ Regla de Oro</h4>
            <p data-lang-key="rule_desc">Si hay una preposiciÃ³n (a, con, de...) antes del conector y es persona, DEBES usar <strong>QUIEN</strong>.</p>
        </div>

        <hr style="border: 0; border-top: 3px dashed var(--orange); margin: 50px 0;">
        <h3 style="color: var(--orange);" data-lang-key="vis_lvl2_title">ğŸ“ FÃ³rmula Nivel 2: PreposiciÃ³n + ArtÃ­culo + Que</h3>
        <p data-lang-key="vis_lvl2_desc">Selecciona el ejemplo para ver la estructura lÃ³gica:</p>

        <div class="formula-visualizer" style="border-color: var(--orange);">
            <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                <button class="action-btn" style="background: white; color: #333; border: 1px solid #ccc;" onclick="setPrepFormula('El chico', 'con', 'el', 'vine')">ğŸ‘¦ El chico</button>
                <button class="action-btn" style="background: white; color: #333; border: 1px solid #ccc;" onclick="setPrepFormula('La herramienta', 'con', 'la', 'trabajÃ©')">ğŸ› ï¸ La herramienta</button>
                <button class="action-btn" style="background: white; color: #333; border: 1px solid #ccc;" onclick="setPrepFormula('Los amigos', 'con', 'los', 'viajÃ©')">âœˆï¸ Los amigos</button>
                <button class="action-btn" style="background: white; color: #333; border: 1px solid #ccc;" onclick="setPrepFormula('Las tijeras', 'con', 'las', 'cortÃ©')">âœ‚ï¸ Las tijeras</button>
            </div>

            <div class="visualizer-display" style="background: rgba(253, 126, 20, 0.05);">
                <span id="demo-noun" class="vis-part" style="background: white; border-color: #ddd;">El chico</span>
                <span id="demo-prep" class="vis-part" style="font-weight:bold; background: transparent;">+ CON +</span>
                <span id="demo-art" class="vis-part" style="background: var(--orange); color: white; transform: scale(1.1);">EL</span>
                <span id="demo-rest" class="vis-part" style="font-weight:bold; background: transparent;">+ QUE vine</span>
            </div>
            <p id="demo-result" style="font-weight: bold; font-size: 1.3rem; color: var(--dark-blue); min-height: 1.5em; margin-top: 15px;">El chico con el que vine.</p>
        </div>
    </div>

    <div id="phrases" class="tab-content">
        <h3 data-lang-key="phrases_title">ğŸ’¬ Banco de Frases Ãštiles</h3>
        <p data-lang-key="phrases_desc">Haz clic en "Explicar" para ver detalles y escuchar.</p>
        <div id="phrase-list"></div>

        <hr style="border: 0; border-top: 3px dashed var(--orange); margin: 50px 0;">
        <h3 style="color: var(--orange);" data-lang-key="phrases_lvl2_title">ğŸ’¬ Frases Nivel 2: Preposiciones Complejas</h3>
        <div id="phrase-list-adv"></div>

        <div id="phrase-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal()">&times;</span>
                <h2 id="modal-es" style="color: var(--primary); margin-bottom: 10px;"></h2>
                <hr style="border: 1px solid var(--border-color);">
                <h3 id="modal-en" style="color: #666; font-weight: 400; margin-bottom: 20px;"></h3>
                <div id="modal-note" style="background: #eef; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 1.05rem;"></div>
                <div style="margin-top: 25px; text-align: center;">
                    <button class="action-btn" onclick="speakModal()" data-lang-key="btn_listen">ğŸ”Š Escuchar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="practice" class="tab-content">
        <div style="text-align: center; margin-bottom: 25px; background: var(--light-gray-bg); padding: 15px; border-radius: 12px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;">
            <button class="action-btn" onclick="loadQuiz()" data-lang-key="btn_quiz">ğŸ“ Quiz (Part 1)</button>
            <button class="action-btn secondary" onclick="loadStory()" data-lang-key="btn_story">ğŸ“– Story (Part 2)</button>
            <button class="action-btn warning" onclick="loadDragDrop()" data-lang-key="btn_sorter">ğŸ¤ Sorter (Part 3)</button>
            <button class="action-btn orange" onclick="loadQuizAdv()" data-lang-key="btn_quiz_lvl2">âš“ Nivel 2</button>
        </div>

        <div id="quiz-section" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;" data-lang-key="quiz_title">ğŸ“ Part 1: Multiple Choice</h3>
                 <button class="action-btn" onclick="generateNewQuiz()" data-lang-key="btn_new_quiz">ğŸ”„ New Quiz</button>
            </div>
            <p class="feedback" style="background: #fff3cd; color: #856404; text-align: left;" data-lang-key="quiz_note">Note: Audio reads context but not answer!</p>
            <div id="quiz-container"></div>
        </div>

        <div id="story-section" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;" data-lang-key="story_title">ğŸ“– Part 2: Complete the Story</h3>
                <button class="action-btn secondary" onclick="generateNewStory()" data-lang-key="btn_new_story">ğŸ”„ New Story</button>
            </div>
            <div class="story-text" id="story-container"></div>
            <br>
            <div style="text-align: center;">
                <button class="action-btn" onclick="checkStory()" data-lang-key="btn_check">âœ… Check Answers</button>
            </div>
        </div>

        <div id="drag-section" class="hidden">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;" data-lang-key="sorter_title">ğŸ¤ Part 3: Drag & Drop Sorter</h3>
                <button class="action-btn warning" onclick="generateNewSorter()" data-lang-key="btn_new_sorter">ğŸ”„ New Sorter</button>
            </div>
            <div class="drag-area">
                <div class="drop-zone" id="zone-que" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h3>Usa "QUE" ğŸƒ</h3>
                </div>
                <div class="drop-zone" id="zone-other" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h3>Usa "QUIEN / DONDE / LO QUE" ğŸ¯</h3>
                </div>
            </div>
            <div id="drag-items-container" style="margin-top: 30px; text-align: center; padding: 20px; background: var(--light-gray-bg); border-radius: 12px; min-height: 120px;"></div>
            <br>
             <div style="text-align: center;">
                <button class="action-btn" onclick="checkSorter()" data-lang-key="btn_check_sorter">âœ… Check Sorter</button>
            </div>
        </div>

        <div id="practice-adv" class="hidden" style="background: rgba(253, 126, 20, 0.05); padding: 20px; border-radius: 12px; border: 1px solid var(--orange);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--orange); margin:0;" data-lang-key="practice_lvl2_title">âš“ Nivel 2: DesafÃ­o de Preposiciones</h3>
                <button class="action-btn orange" onclick="generateNewQuizAdv()">ğŸ”„ Nuevo</button>
            </div>
            <p data-lang-key="practice_lvl2_desc">Elige el artÃ­culo correcto (el, la, los, las) para completar la frase.</p>
            <div id="quiz-adv-container" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="flashcards" class="tab-content">
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="action-btn" onclick="switchDeck('basic')" data-lang-key="btn_deck_basic">Nivel 1 (BÃ¡sico)</button>
            <button class="action-btn orange" onclick="switchDeck('adv')" data-lang-key="btn_deck_adv">Nivel 2 (Prep)</button>
        </div>

        <div class="flashcard-container" id="flashcard-container">
            <div class="flashcard-inner" id="flashcard">
                <div class="flashcard-front">
                    <h2 id="fc-front" style="font-size: 1.8rem;">Front</h2>
                    <p style="font-size: 1rem; color: #999; margin-top: 20px;" data-lang-key="fc_tap">(Haz clic para girar ğŸ‘†)</p>
                </div>
                <div class="flashcard-back">
                    <div class="flashcard-text" id="fc-back-es">Back Spanish</div>
                    <div class="flashcard-sub" id="fc-back-en">Back English</div>
                    <div id="fc-audio-container"></div>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 30px;">
            <button class="action-btn" onclick="prevCard()" data-lang-key="btn_prev">â¬…ï¸ Anterior</button>
            <button class="action-btn" onclick="nextCard()" data-lang-key="btn_next">Siguiente â¡ï¸</button>
        </div>
    </div>

</div>

<script>
    // --- UI & TRANSLATION DATA ---
    let currentLang = 'es';
    const uiData = {
        es: {
            subtitle: "Conecta ideas con: Que, Quien, Donde, Lo que",
            tab_concept: "ğŸ§  Concepto",
            tab_formula: "ğŸ“ FÃ³rmula",
            tab_phrases: "ğŸ’¬ Frases",
            tab_practice: "ğŸ® PrÃ¡ctica",
            tab_flashcards: "âš¡ Flashcards",
            meta_title: "La MetÃ¡fora: La Etiquetadora (The Label Maker)",
            meta_desc1: "Imagina que tienes una caja genÃ©rica llamada 'El libro' (The book). ğŸ“¦",
            meta_desc2: "Una ClÃ¡usula Adjetiva es como una etiqueta adhesiva que pegas en esa caja para hacerla especÃ­fica.",
            video_title: "ğŸ“¹ Video Tutorial Interactivo",
            vis_title: "ğŸ§™â€â™‚ï¸ FÃ³rmula Visual Interactiva",
            vis_desc: "Haz clic en los botones para construir la frase y ver cÃ³mo cambia el conector.",
            vis_choose: "Elige el Antecedente:",
            formula_title: "ğŸ“ La FÃ³rmula de ConexiÃ³n",
            formula_desc: "El 'pegamento' (conector) cambia dependiendo de quÃ© estamos describiendo.",
            th_ant: "Antecedente", th_con: "Conector ğŸ”—", th_ex: "Ejemplo Completo ğŸ“",
            rule_title: "âš ï¸ Regla de Oro",
            rule_desc: "Si hay una preposiciÃ³n (a, con, de...) antes del conector y es persona, DEBES usar QUIEN.",
            phrases_title: "ğŸ’¬ Banco de Frases Ãštiles",
            phrases_desc: "Haz clic en 'Explicar' para ver detalles y escuchar.",
            btn_listen: "ğŸ”Š Escuchar",
            btn_quiz: "ğŸ“ Quiz (Parte 1)", btn_story: "ğŸ“– Historia (Parte 2)", btn_sorter: "ğŸ¤ Sorter (Parte 3)",
            quiz_title: "ğŸ“ Parte 1: OpciÃ³n MÃºltiple", btn_new_quiz: "ğŸ”„ Nuevo Quiz",
            quiz_note: "Nota: Â¡El audio lee el contexto para ayudarte!",
            story_title: "ğŸ“– Parte 2: Completa la Historia", btn_new_story: "ğŸ”„ Nueva Historia", btn_check: "âœ… Verificar",
            sorter_title: "ğŸ¤ Parte 3: Clasificador Drag & Drop", btn_new_sorter: "ğŸ”„ Nuevo Sorter", btn_check_sorter: "âœ… Verificar",
            btn_prev: "â¬…ï¸ Anterior", btn_next: "Siguiente â¡ï¸", fc_tap: "(Haz clic para girar ğŸ‘†)",
            // KEYS NIVEL 2
            meta_lvl2_title: "âš“ NIVEL 2: La MetÃ¡fora del Ancla",
            meta_lvl2_desc: "Cuando usas preposiciones (en, con...), el 'QUE' es dÃ©bil. Necesitas un ANCLA (el, la, los, las).",
            vis_lvl2_title: "ğŸ“ FÃ³rmula Nivel 2: PreposiciÃ³n + ArtÃ­culo + Que",
            vis_lvl2_desc: "Selecciona el ejemplo para ver la estructura lÃ³gica:",
            phrases_lvl2_title: "ğŸ’¬ Frases Nivel 2: Preposiciones Complejas",
            practice_lvl2_title: "âš“ Nivel 2: DesafÃ­o de Preposiciones",
            practice_lvl2_desc: "Elige el artÃ­culo correcto (el, la, los, las) para completar la frase.",
            btn_quiz_lvl2: "âš“ Nivel 2 (Preposiciones)",
            btn_deck_basic: "Nivel 1 (BÃ¡sico)",
            btn_deck_adv: "Nivel 2 (Prep)"
        },
        en: {
            subtitle: "Connect ideas with: Que, Quien, Donde, Lo que",
            tab_concept: "ğŸ§  Concept",
            tab_formula: "ğŸ“ Formula",
            tab_phrases: "ğŸ’¬ Phrases",
            tab_practice: "ğŸ® Practice",
            tab_flashcards: "âš¡ Flashcards",
            meta_title: "The Metaphor: The Label Maker",
            meta_desc1: "Imagine you have a generic box called 'The book'. ğŸ“¦",
            meta_desc2: "An Adjective Clause is like a sticky label you put on that box to make it specific.",
            video_title: "ğŸ“¹ Interactive Video Tutorial",
            vis_title: "ğŸ§™â€â™‚ï¸ Interactive Formula Visualizer",
            vis_desc: "Click the buttons to build the sentence and see how the connector changes.",
            vis_choose: "Choose the Antecedent:",
            formula_title: "ğŸ“ The Connection Formula",
            formula_desc: "The 'glue' (connector) changes depending on what we are describing.",
            th_ant: "Antecedent", th_con: "Connector ğŸ”—", th_ex: "Full Example ğŸ“",
            rule_title: "âš ï¸ Golden Rule",
            rule_desc: "If there is a preposition (a, con, de...) before the connector and it's a person, you MUST use QUIEN.",
            phrases_title: "ğŸ’¬ Useful Phrases Bank",
            phrases_desc: "Click 'Explain' to see details and listen.",
            btn_listen: "ğŸ”Š Listen",
            btn_quiz: "ğŸ“ Quiz (Part 1)", btn_story: "ğŸ“– Story (Part 2)", btn_sorter: "ğŸ¤ Sorter (Part 3)",
            quiz_title: "ğŸ“ Part 1: Multiple Choice", btn_new_quiz: "ğŸ”„ New Quiz",
            quiz_note: "Note: Audio reads the context to help you!",
            story_title: "ğŸ“– Part 2: Complete the Story", btn_new_story: "ğŸ”„ New Story", btn_check: "âœ… Check Answers",
            sorter_title: "ğŸ¤ Part 3: Drag & Drop Sorter", btn_new_sorter: "ğŸ”„ New Sorter", btn_check_sorter: "âœ… Check Sorter",
            btn_prev: "â¬…ï¸ Previous", btn_next: "Next â¡ï¸", fc_tap: "(Click to flip ğŸ‘†)",
            // KEYS NIVEL 2
            meta_lvl2_title: "âš“ LEVEL 2: The Anchor Metaphor",
            meta_lvl2_desc: "When using prepositions (en, con...), 'QUE' is weak. You need an ANCHOR (el, la, los, las).",
            vis_lvl2_title: "ğŸ“ Level 2 Formula: Preposition + Article + Que",
            vis_lvl2_desc: "Select the object to see which 'Anchor' (article) you need.",
            phrases_lvl2_title: "ğŸ’¬ Level 2 Phrases: Complex Prepositions",
            practice_lvl2_title: "âš“ Level 2: Preposition Challenge",
            practice_lvl2_desc: "Choose the correct article (el, la, los, las) to complete the phrase.",
            btn_quiz_lvl2: "âš“ Level 2 (Prepositions)",
            btn_deck_basic: "Level 1 (Basic)",
            btn_deck_adv: "Level 2 (Prep)"
        }
    };

    function toggleLang() {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if(uiData[currentLang][key]) el.innerHTML = uiData[currentLang][key];
        });
    }

    // --- SISTEMA DE VOZ BLINDADO ---
    let voices = [];
    function loadVoices() { voices = window.speechSynthesis.getVoices(); }
    if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = loadVoices; }

    function speak(text) {
        window.speechSynthesis.cancel();
        
        // 1. SOLUCIÃ“N AL DELETREO Y EMOJIS: 
        // - .toLowerCase(): Evita que QUE se lea Q-U-E
        // - regex: Elimina todo lo que NO sea letra, nÃºmero o puntuaciÃ³n bÃ¡sica
        let cleanText = text.toLowerCase()
                            .replace(/[\u{1F600}-\u{1F6FF}]/gu, '') // AdiÃ³s emojis
                            .replace(/[^a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±Ã¼\s,.\?!]/g, '') // Filtro estricto (solo letras/tildes)
                            .replace(/\s+/g, ' ')
                            .trim();

        const u = new SpeechSynthesisUtterance(cleanText);
        u.lang = 'es-ES'; 
        u.rate = 0.9;

        if (voices.length === 0) voices = window.speechSynthesis.getVoices();
        
        // Preferir Google o Microsoft en espaÃ±ol
        const spanishVoice = voices.find(v => v.lang.includes('es') && (v.name.includes('Google') || v.name.includes('Microsoft'))) ||
                             voices.find(v => v.lang.startsWith('es')); 

        if (spanishVoice) { u.voice = spanishVoice; }

        window.speechSynthesis.speak(u);
    }

    // --- VISUALIZER LOGIC (NIVEL 1) ---
    function updateVisualizer(type) {
        const ant = document.getElementById('vis-ant');
        const con = document.getElementById('vis-con');
        const cla = document.getElementById('vis-cla');

        if (type === 'persona') {
            ant.innerHTML = "La persona ğŸ‘¤";
            con.innerHTML = "+ QUIEN / QUE ğŸ”— +";
            cla.innerHTML = "me ayudÃ³ es amable. ğŸ˜Š";
        } else if (type === 'cosa') {
            ant.innerHTML = "El coche ğŸš—";
            con.innerHTML = "+ QUE ğŸ”— +";
            cla.innerHTML = "alquilÃ© es rÃ¡pido. ğŸ’¨";
        } else if (type === 'lugar') {
            ant.innerHTML = "El hotel ğŸ¨";
            con.innerHTML = "+ DONDE ğŸ”— +";
            cla.innerHTML = "nos quedamos es lujoso. âœ¨";
        }
        con.style.transform = 'scale(1.2)';
        setTimeout(() => con.style.transform = 'scale(1.1)', 300);
    }

    // --- DATA ---
    const phrasesData = [
        { es: "El libro ğŸ“˜ que estoy leyendo es fascinante.", en: "The book that I am reading is fascinating.", note: "Uso bÃ¡sico de 'que' para cosas." },
        { es: "La mujer ğŸ‘©â€ğŸ’¼ con quien hablÃ© era mi jefa.", en: "The woman with whom I spoke was my boss.", note: "'Quien' es obligatorio despuÃ©s de preposiciÃ³n." },
        { es: "Este es el restaurante ğŸ½ï¸ donde nos conocimos.", en: "This is the restaurant where we met.", note: "'Donde' para lugares fÃ­sicos o figurados." },
        { es: "No entiendo lo que ğŸ¤” dices.", en: "I don't understand what you are saying.", note: "'Lo que' para ideas abstractas." },
        { es: "Busco una persona ğŸ” que sepa cocinar.", en: "I'm looking for a person who knows how to cook.", note: "'Que' para personas sin preposiciÃ³n." },
        { es: "El estudiante cuyo ğŸ’ libro se perdiÃ³.", en: "The student whose book was lost.", note: "'Cuyo' indica posesiÃ³n (whose)." },
        { es: "La razÃ³n por la que â“ vine es secreta.", en: "The reason (why) I came is secret.", note: "Usamos 'por la que' o 'que' para razones." },
        { es: "Todo lo que âœ¨ brilla no es oro.", en: "All that glitters is not gold.", note: "'Todo lo que' es una frase fija comÃºn." },
        { es: "El aÃ±o cuando ğŸ“… nacÃ­ fue especial.", en: "The year when I was born was special.", note: "A veces usamos 'cuando' o 'en que' para tiempo." },
        { es: "Es el chico a quien ğŸ di el regalo.", en: "He is the boy to whom I gave the gift.", note: "PreposiciÃ³n 'a' + quien (objeto indirecto)." }
    ];

    const quizData = [
        { q: "El chico ğŸ‘¦ ___ vive allÃ­ es mi amigo.", options: ["que", "quien", "donde"], a: "que", audio: "El chico que vive allÃ­ es mi amigo." },
        { q: "La chica ğŸ‘§ con ___ fui al cine es Ana.", options: ["quien", "que", "donde"], a: "quien", audio: "La chica con quien fui al cine es Ana." },
        { q: "La ciudad ğŸ™ï¸ ___ nacÃ­ es hermosa.", options: ["donde", "que", "quien"], a: "donde", audio: "La ciudad donde nacÃ­ es hermosa." },
        { q: "Eso es exactamente ___ ğŸ’¡ yo pensaba.", options: ["lo que", "que", "donde"], a: "lo que", audio: "Eso es exactamente lo que yo pensaba." },
        { q: "El coche ğŸš— ___ alquilamos es nuevo.", options: ["que", "quien", "donde"], a: "que", audio: "El coche que alquilamos es nuevo." },
        { q: "Los estudiantes ğŸ“ a ___ enseÃ±o son aplicados.", options: ["quienes", "que", "donde"], a: "quienes", audio: "Los estudiantes a quienes enseÃ±o son aplicados." },
        { q: "El parque ğŸŒ³ ___ jugamos de niÃ±os ya no existe.", options: ["donde", "que", "quien"], a: "donde", audio: "El parque donde jugamos de niÃ±os ya no existe." },
        { q: "La novela ğŸ“– ___ me prestaste es muy larga.", options: ["que", "quien", "donde"], a: "que", audio: "La novela que me prestaste es muy larga." },
        { q: "El hombre ğŸ‘¨â€ğŸ¦³ de ___ te hablÃ© es mi tÃ­o.", options: ["quien", "que", "donde"], a: "quien", audio: "El hombre de quien te hablÃ© es mi tÃ­o." },
        { q: "No escuchÃ© ___ ğŸ‘‚ dijiste.", options: ["lo que", "que", "donde"], a: "lo que", audio: "No escuchÃ© lo que dijiste." }
    ];

    // --- EXPANDED STORIES (5 Sentences Each) ---
    const storiesData = [
        `<strong>Historia 1: El Restaurante</strong><br>
        Ayer fui a un restaurante ğŸ½ï¸ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> me recomendaste hace tiempo. 
        El camarero ğŸ‘¨â€ğŸ³ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> nos atendiÃ³ fue increÃ­blemente amable y rÃ¡pido. 
        Era el lugar exacto <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="lo que">lo que</option></select> hacen la mejor paella de la ciudad. 
        Al principio, no sabÃ­a <select class="story-input" data-ans="lo que"><option value="">___</option><option value="lo que">lo que</option><option value="que">que</option></select> pedir porque todo olÃ­a delicioso.
        Finalmente, mi amiga, con <select class="story-input" data-ans="quien"><option value="">___</option><option value="quien">quien</option><option value="que">que</option></select> fui a cenar, eligiÃ³ el postre por mÃ­.`,
        
        `<strong>Historia 2: El Cine</strong><br>
        La pelÃ­cula ğŸ¬ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> vimos anoche fue terrible.
        El cine ğŸ¿ <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="quien">quien</option></select> estÃ¡bamos hacÃ­a mucho frÃ­o y no funcionaba la calefacciÃ³n.
        <select class="story-input" data-ans="Lo que"><option value="">___</option><option value="Lo que">Lo que</option><option value="Que">Que</option></select> mÃ¡s me molestÃ³ fue el final inesperado y absurdo.
        Los actores ğŸ­ a <select class="story-input" data-ans="quienes"><option value="">___</option><option value="quienes">quienes</option><option value="que">que</option></select> admiro normalmente, actuaron muy mal en esta ocasiÃ³n.
        Fue una experiencia <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> prefiero olvidar pronto.`,

        `<strong>Historia 3: La Escuela</strong><br>
        La escuela ğŸ« <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> estudiÃ© primaria era un edificio muy antiguo y bonito.
        Los profesores ğŸ‘¨â€ğŸ« a <select class="story-input" data-ans="quienes"><option value="">___</option><option value="quienes">quienes</option><option value="que">que</option></select> recuerdo con cariÃ±o me enseÃ±aron a leer y escribir.
        Es una Ã©poca <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> nunca olvidarÃ©, llena de juegos y risas.
        AÃºn conservo los libros ğŸ“š <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> usÃ¡bamos en clase de historia.
        <select class="story-input" data-ans="Lo que"><option value="">___</option><option value="Lo que">Lo que</option><option value="Que">Que</option></select> mÃ¡s extraÃ±o son los recreos interminables con mis amigos.`,

        `<strong>Historia 4: El Viaje</strong><br>
        El viaje âœˆï¸ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> hicimos a PerÃº fue simplemente mÃ¡gico e inolvidable.
        El guÃ­a turÃ­stico con <select class="story-input" data-ans="quien"><option value="">___</option><option value="quien">quien</option><option value="que">que</option></select> anduvimos sabÃ­a mucho sobre los Incas.
        Vimos paisajes y montaÃ±as <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="lo que">lo que</option></select> nunca imaginÃ© que existieran.
        El hotel <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> dormimos tenÃ­a vistas a las ruinas antiguas.
        Todo <select class="story-input" data-ans="lo que"><option value="">___</option><option value="lo que">lo que</option><option value="que">que</option></select> comimos allÃ­ estaba delicioso y picante.`,

        `<strong>Historia 5: La Fiesta</strong><br>
        Realmente no sÃ© <select class="story-input" data-ans="lo que"><option value="">___</option><option value="lo que">lo que</option><option value="que">que</option></select> pasÃ³ exactamente en la fiesta ğŸ‰ de anoche.
        La casa <select class="story-input" data-ans="donde"><option value="">___</option><option value="donde">donde</option><option value="que">que</option></select> se celebrÃ³ el evento era enorme y tenÃ­a piscina.
        La mÃºsica ğŸµ <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> puso el DJ era genial y todos bailaron.
        ConocÃ­ a una chica <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="quien">quien</option></select> bailaba salsa increÃ­blemente bien.
        Fue una noche <select class="story-input" data-ans="que"><option value="">___</option><option value="que">que</option><option value="donde">donde</option></select> recordaremos por mucho tiempo.`
    ];

    const dragData = [
        { text: "El libro ğŸ“˜ ___ leÃ­.", type: "que", audio: "El libro que leÃ­." },
        { text: "La chica con ___ ğŸ’ƒ bailÃ©.", type: "other", audio: "La chica con quien bailÃ©." },
        { text: "El parque ___ ğŸŒ³ corro.", type: "other", audio: "El parque donde corro." },
        { text: "___ ğŸ¤” piensas.", type: "other", audio: "Lo que piensas." }
    ];

    // --- DATA NIVEL 2 ---
    const phrasesAdv = [
        {es: "El chico con el que hablÃ©.", en: "The boy with whom I spoke.", note: "Chico (M) -> con EL que."},
        {es: "La casa en la que vivo.", en: "The house in which I live.", note: "Casa (F) -> en LA que."},
        {es: "Los documentos sin los que viajo.", en: "The docs without which I travel.", note: "Documentos (Pl M) -> sin LOS que."},
        {es: "Las razones por las que llorÃ©.", en: "The reasons for which I cried.", note: "Razones (Pl F) -> por LAS que."},
        {es: "El tema del que hablamos.", en: "The topic about which we spoke.", note: "De + el = DEL que."}
    ];

    const quizDataAdv = [
        {q: "El parque en _____ corremos.", opts: ["el que", "la que", "los que"], a: "el que"},
        {q: "La silla en _____ me sentÃ©.", opts: ["la que", "el que", "las que"], a: "la que"},
        {q: "Los amigos con _____ salÃ­.", opts: ["los que", "el que", "las que"], a: "los que"},
        {q: "Las ciudades por _____ viajÃ©.", opts: ["las que", "los que", "la que"], a: "las que"},
        {q: "El lÃ¡piz con _____ escribo.", opts: ["el que", "la que", "lo que"], a: "el que"}
    ];

    const flashcardsData = [
        { en: "The book ğŸ“˜ that I bought", es: "El libro que comprÃ©" },
        { en: "The girl ğŸ‘§ with whom I study", es: "La chica con quien estudio" },
        { en: "The place ğŸ  where we eat", es: "El lugar donde comemos" }
    ];
    
    // MAZO AMPLIADO (23 ITEMS)
    const flashcardsAdv = [
        {en: "The house in which I live", es: "La casa en LA que vivo"},
        {en: "The boy with whom I spoke", es: "El chico con EL que hablÃ©"},
        {en: "The friends with whom I went", es: "Los amigos con LOS que fui"},
        {en: "The pen with which I write", es: "La pluma con LA que escribo"},
        {en: "The bridge under which we walked", es: "El puente bajo EL que caminamos"},
        {en: "The chair on which I sit", es: "La silla sobre LA que me siento"},
        {en: "The students to whom I teach", es: "Los alumnos a LOS que enseÃ±o"},
        {en: "The windows through which I look", es: "Las ventanas por LAS que miro"},
        {en: "The reason for which I came", es: "La razÃ³n por LA que vine"},
        {en: "The topic about which we talked", es: "El tema del que hablamos"},
        {en: "The company for which I work", es: "La empresa para LA que trabajo"},
        {en: "The tools with which I build", es: "Las herramientas con LAS que construyo"},
        {en: "The day on which we met", es: "El dÃ­a en EL que nos conocimos"},
        {en: "The boat on which I sail", es: "El barco en EL que navego"},
        {en: "The laws against which they protested", es: "Las leyes contra LAS que protestaron"},
        {en: "The knife with which I cut", es: "El cuchillo con EL que corto"},
        {en: "The shoes with which I run", es: "Los zapatos con LOS que corro"},
        {en: "The city towards which we travel", es: "La ciudad hacia LA que viajamos"},
        {en: "The girls with whom I dance", es: "Las chicas con LAS que bailo"},
        {en: "The notebook in which I write", es: "El cuaderno en EL que escribo"},
        {en: "The building from which I left", es: "El edificio DEL que salÃ­"},
        {en: "The project on which I work", es: "El proyecto en EL que trabajo"},
        {en: "The table under which the cat hides", es: "La mesa bajo LA que se esconde el gato"}
    ];

    // --- LOGIC ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll(`.tab-btn[onclick*="${tabId}"]`).forEach(b => b.classList.add('active'));
    }

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    // Modal
    const phraseList = document.getElementById('phrase-list');
    phrasesData.forEach(p => {
        let div = document.createElement('div');
        div.className = 'phrase-item';
        div.innerHTML = `<span style="font-size: 1.1rem;">${p.es}</span> <button class="action-btn explain-btn">Explicar ğŸ’¡</button>`;
        div.querySelector('.explain-btn').addEventListener('click', (e) => { e.stopPropagation(); openModal(p); });
        phraseList.appendChild(div);
    });
    let currentModalText = "";
    function openModal(data) {
        document.getElementById('modal-es').innerText = data.es;
        document.getElementById('modal-en').innerText = data.en;
        document.getElementById('modal-note').innerHTML = "<strong>ğŸ’¡ ExplicaciÃ³n:</strong> " + data.note;
        currentModalText = data.es;
        document.getElementById('phrase-modal').classList.add('active');
    }
    function closeModal() { document.getElementById('phrase-modal').classList.remove('active'); }
    function speakModal() { speak(currentModalText); }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Activities Navigation (Consolidated)
    function hideAllPractice() {
        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('story-section').classList.add('hidden');
        document.getElementById('drag-section').classList.add('hidden');
        document.getElementById('practice-adv').classList.add('hidden');
    }

    function loadQuiz() {
        hideAllPractice();
        document.getElementById('quiz-section').classList.remove('hidden');
        if(document.getElementById('quiz-container').innerHTML === "") generateNewQuiz();
    }
    function loadStory() {
        hideAllPractice();
        document.getElementById('story-section').classList.remove('hidden');
        if(document.getElementById('story-container').innerHTML === "") generateNewStory();
    }
    function loadDragDrop() {
        hideAllPractice();
        document.getElementById('drag-section').classList.remove('hidden');
        if(document.getElementById('drag-items-container').innerHTML === "") generateNewSorter();
    }
    
    function loadQuizAdv() {
        hideAllPractice();
        document.getElementById('practice-adv').classList.remove('hidden');
        if(document.getElementById('quiz-adv-container').innerHTML === "") generateNewQuizAdv();
    }

    // --- QUIZ LOGIC (Level 1) ---
    function generateNewQuiz() {
        const c = document.getElementById('quiz-container'); c.innerHTML = '';
        shuffleArray([...quizData]).slice(0, 5).forEach((item, i) => {
            let div = document.createElement('div'); div.className = 'quiz-question';
            let html = `<p><strong>${i+1}.</strong> ${item.q} <span class="tts-icon" onclick="speak('${item.audio}')" style="font-size:1.2rem">ğŸ”Š</span></p><div class="options-grid">`;
            shuffleArray([...item.options]).forEach(opt => html += `<button class="option-btn" onclick="checkQuiz(this, '${opt}', '${item.a}')">${opt}</button>`);
            div.innerHTML = html + `</div><p class="feedback hidden"></p>`;
            c.appendChild(div);
        });
    }
    function checkQuiz(btn, sel, cor) {
        const p = btn.closest('.quiz-question');
        const f = p.querySelector('.feedback');
        p.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
        if(sel === cor) { btn.classList.add('correct'); f.style.background='#d4edda'; f.style.color='#155724'; f.innerText="Correcto! ğŸ‰"; }
        else { btn.classList.add('incorrect'); f.style.background='#f8d7da'; f.style.color='#721c24'; f.innerText=`Incorrecto. Respuesta: ${cor}`; }
        f.classList.remove('hidden');
    }

    // --- QUIZ LOGIC (Level 2) ---
    function generateNewQuizAdv() {
        const c = document.getElementById('quiz-adv-container'); c.innerHTML = '';
        shuffleArray([...quizDataAdv]).forEach((item, i) => {
            let div = document.createElement('div'); div.className = 'quiz-question'; div.style.borderLeftColor = 'var(--orange)';
            let html = `<p><strong>${i+1}.</strong> ${item.q}</p><div class="options-grid">`;
            item.opts.forEach(opt => html += `<button class="option-btn" onclick="checkQuizAdv(this, '${opt}', '${item.a}')">${opt}</button>`);
            div.innerHTML = html + `</div><p class="feedback hidden"></p>`;
            c.appendChild(div);
        });
    }
    function checkQuizAdv(btn, sel, cor) {
        const p = btn.closest('.quiz-question');
        const f = p.querySelector('.feedback');
        p.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
        if(sel === cor) { 
            btn.classList.add('correct'); btn.style.backgroundColor='#d4edda'; f.style.color='#155724'; f.innerText="Â¡Correcto! El artÃ­culo coincide."; 
            speak("Correcto");
        } else { 
            btn.classList.add('incorrect'); btn.style.backgroundColor='#f8d7da'; f.style.color='#721c24'; f.innerText=`Incorrecto. Respuesta: ${cor}`; 
        }
        f.classList.remove('hidden');
    }

    // --- STORY LOGIC ---
    function generateNewStory() {
        document.getElementById('story-container').innerHTML = storiesData[Math.floor(Math.random() * storiesData.length)];
    }
    function checkStory() {
        const inp = document.querySelectorAll('.story-input');
        let allOk = true;
        inp.forEach(i => { if(i.value === i.dataset.ans) i.className='story-input correct'; else { i.className='story-input incorrect'; allOk=false; }});
        if(allOk && inp.length > 0) speak("Â¡Excelente trabajo!");
    }

    // --- SORTER LOGIC ---
    let draggedItem = null;
    function generateNewSorter() {
        const c = document.getElementById('drag-items-container'); c.innerHTML = '';
        document.querySelectorAll('.drop-zone').forEach(z => { 
            const h = z.querySelector('h3'); z.innerHTML=''; z.appendChild(h); z.classList.remove('drag-over'); 
        });
        shuffleArray([...dragData]).slice(0, 8).forEach(item => {
            let el = document.createElement('div'); el.className = 'drag-item'; el.draggable = true;
            el.innerHTML = `<span>${item.text}</span> <span class="tts-icon" onclick="event.stopPropagation(); speak('${item.audio}')">ğŸ”Š</span>`;
            el.dataset.type = item.type;
            el.addEventListener('dragstart', function() { draggedItem = this; setTimeout(()=>this.style.opacity='0.5',0); });
            el.addEventListener('dragend', function() { this.style.opacity='1'; draggedItem=null; document.querySelectorAll('.drop-zone').forEach(z=>z.classList.remove('drag-over')); });
            el.addEventListener('touchstart', handleTouchStart, {passive:false});
            el.addEventListener('touchmove', handleTouchMove, {passive:false});
            el.addEventListener('touchend', handleTouchEnd);
            c.appendChild(el);
        });
    }
    
    // Touch Logic
    let tEl=null, tX=0, tY=0;
    function handleTouchStart(e) { if(e.target.classList.contains('tts-icon')) return; tEl=e.currentTarget; const t=e.targetTouches[0]; const r=tEl.getBoundingClientRect(); tX=t.clientX-r.left; tY=t.clientY-r.top; tEl.style.position='fixed'; tEl.style.zIndex=1000; tEl.style.width=r.width+'px'; tEl.style.left=(t.clientX-tX)+'px'; tEl.style.top=(t.clientY-tY)+'px'; document.body.appendChild(tEl); e.preventDefault(); }
    function handleTouchMove(e) { if(!tEl)return; const t=e.targetTouches[0]; tEl.style.left=(t.clientX-tX)+'px'; tEl.style.top=(t.clientY-tY)+'px'; e.preventDefault(); }
    function handleTouchEnd(e) { if(!tEl)return; tEl.style.display='none'; let el=document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY); tEl.style.display='inline-flex'; let zone=el?el.closest('.drop-zone'):null; tEl.style.position=''; tEl.style.zIndex=''; tEl.style.width=''; if(zone) zone.appendChild(tEl); else document.getElementById('drag-items-container').appendChild(tEl); tEl=null; }
    
    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
    function drop(e) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); if(draggedItem) e.currentTarget.appendChild(draggedItem); }
    function checkSorter() {
        let sc=0, tot=0;
        ['zone-que','zone-other'].forEach(id => {
            let type = id==='zone-que'?'que':'other';
            document.getElementById(id).querySelectorAll('.drag-item').forEach(i => { tot++; if(i.dataset.type===type){i.style.backgroundColor='var(--green)'; sc++;} else i.style.backgroundColor='var(--red)'; });
        });
        if(tot>0 && sc===tot) speak("Â¡Perfecto!");
    }

    // --- FORMULA INTERACTIVE ---
    function setPrepFormula(noun, prep, art, verb) {
        document.getElementById('demo-noun').innerText = noun;
        document.getElementById('demo-prep').innerText = "+ " + prep.toUpperCase() + " +";
        document.getElementById('demo-art').innerText = art.toUpperCase();
        document.getElementById('demo-rest').innerText = "+ QUE " + verb;
        
        let sentence = `${noun} ${prep} ${art} que ${verb}.`;
        document.getElementById('demo-result').innerHTML = sentence;
        speak(sentence);
    }

    // --- FLASHCARDS ---
    let fcIdx = 0;
    let currentFlashcards = flashcardsData; 

    function updateCard() {
        document.getElementById('flashcard-container').classList.remove('is-flipped');
        setTimeout(() => {
            let d = currentFlashcards[fcIdx];
            document.getElementById('fc-front').innerText = d.en;
            document.getElementById('fc-back-es').innerText = d.es;
            document.getElementById('fc-back-en').innerText = d.en;
            let ac = document.getElementById('fc-audio-container'); ac.innerHTML='';
            let icon = document.createElement('span'); icon.className='tts-icon'; icon.innerText='ğŸ”Š';
            icon.onclick=(e)=>{e.stopPropagation(); speak(d.es);}; ac.appendChild(icon);
        }, 200);
    }
    document.getElementById('flashcard').onclick=(e)=>{ if(!e.target.classList.contains('tts-icon')) document.getElementById('flashcard-container').classList.toggle('is-flipped'); };
    function nextCard() { fcIdx=(fcIdx+1)%currentFlashcards.length; updateCard(); }
    function prevCard() { fcIdx=(fcIdx-1+currentFlashcards.length)%currentFlashcards.length; updateCard(); }
    
    function switchDeck(type) {
        currentFlashcards = (type === 'adv') ? flashcardsAdv : flashcardsData;
        fcIdx = 0;
        updateCard();
        speak(type === 'adv' ? "Nivel Avanzado" : "Nivel BÃ¡sico");
    }

    // --- FILL NIVEL 2 LIST ---
    const advList = document.getElementById('phrase-list-adv');
    if(advList) {
        phrasesAdv.forEach(p => {
            let div = document.createElement('div');
            div.className = 'phrase-item';
            div.style.borderLeftColor = 'var(--orange)';
            div.innerHTML = `<span style="font-size: 1.1rem;">${p.es}</span> <button class="action-btn orange" style="font-size:0.8rem; padding: 5px 10px;">Explicar âš“</button>`;
            div.querySelector('button').addEventListener('click', (e) => { e.stopPropagation(); openModal(p); });
            advList.appendChild(div);
        });
    }

    // Init Logic
    loadVoices(); // Intentar cargar voces al inicio
    updateCard();
    updateVisualizer('persona'); 
</script>
</body>
</html>
