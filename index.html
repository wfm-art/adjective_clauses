<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Adjective Clauses | SPA Educativa</title>
    <style>
        :root {
            /* COLORES */
            --primary-blue: #0069d9;
            --header-bg: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #ffc107;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 12px;
        }

        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.5);
            --primary-blue: #375a7f;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        /* LAYOUT PRINCIPAL */
        .app-container {
            width: 100%;
            max-width: 950px;
            background: var(--card-bg);
            min-height: 100vh;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @media(min-width: 960px) {
            .app-container {
                margin: 20px;
                min-height: calc(100vh - 40px);
                border-radius: var(--radius);
                overflow: hidden;
            }
        }

        /* HEADER */
        header {
            background-color: #0d6efd;
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .header-content { text-align: center; flex-grow: 1; }
        .header-title { font-size: 2rem; font-weight: 700; margin: 0; letter-spacing: -0.5px; }
        .header-subtitle { font-size: 0.95rem; opacity: 0.9; font-weight: 400; margin-top: 5px; display: block;}

        .header-controls { display: flex; gap: 10px; }
        .header-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .header-btn:hover { background: rgba(255,255,255,0.1); }

        /* TABS NAVIGATION */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        body.dark-mode .tabs { background: #1e1e1e; }

        .tab-btn {
            flex: 1;
            padding: 18px 15px;
            border: none;
            background: transparent;
            color: #6c757d;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            min-width: 160px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: capitalize;
        }
        .tab-btn span:first-child { font-size: 1.4rem; }
        
        .tab-btn.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
            background: rgba(13, 110, 253, 0.05);
        }
        body.dark-mode .tab-btn.active { color: #6ea8fe; border-bottom-color: #6ea8fe; }

        /* CONTENT AREAS */
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* COMMON */
        h2 { color: var(--primary-blue); margin-top: 0; font-size: 1.8rem; margin-bottom: 25px; }
        .btn {
            padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;
            font-weight: bold; color: white; background: var(--primary-blue);
            transition: transform 0.1s, opacity 0.2s;
            font-size: 1rem;
        }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary-blue); color: var(--primary-blue); }
        
        .action-btn-container { text-align: center; margin-top: 25px; }
        .action-btn-container .btn { min-width: 200px; }

        /* CONCEPT & FORMULA CARDS */
        .concept-cards, .formula-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .concept-card, .formula-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .cc-icon { font-size: 4.5rem; margin-bottom: 15px; display: block; }
        .cc-title { font-size: 1.5rem; font-weight: 800; color: #0d6efd; margin-bottom: 10px; }
        .cc-desc { font-size: 1rem; line-height: 1.6; color: var(--text-color); }
        .cc-example { 
            margin-top: 15px; font-style: italic; background: rgba(0,0,0,0.04); 
            padding: 12px; border-radius: 8px; font-size: 0.95rem; color: #555;
        }
        body.dark-mode .cc-example { color: #ccc; }

        /* FORMULA SPECIFIC STYLES */
        .formula-card h3 { color: var(--primary-blue); margin-bottom: 10px; }
        .formula-rule { 
            background: rgba(13, 110, 253, 0.1); padding: 8px; 
            border-radius: 6px; font-weight: bold; color: var(--primary-blue);
            display: inline-block; margin-bottom: 15px;
        }
        body.dark-mode .formula-rule { background: rgba(110, 168, 254, 0.2); color: #6ea8fe; }

        /* VIDEO & FORMULA INTERACTIVE */
        .video-container {
            width: 100%; max-width: 800px; margin: 0 auto 40px auto;
            border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); background: #000;
        }
        .video-frame { width: 100%; aspect-ratio: 16/9; border: none; }

        .interactive-formula {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 30px; margin-top: 30px; text-align: center;
            box-shadow: var(--shadow);
        }
        .formula-display-area {
            border: 3px dashed var(--border-color); border-radius: 12px;
            padding: 30px; margin: 25px 0; min-height: 140px;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; background: rgba(0,0,0,0.02);
        }
        .big-emoji-row { font-size: 4rem; margin-bottom: 15px; }
        .formula-text { font-size: 1.4rem; font-weight: 700; color: var(--text-color); }

        /* PRACTICE MODES */
        .practice-section-title {
            background: #e9ecef; color: #495057; padding: 12px 20px;
            border-radius: 8px; margin: 50px 0 25px 0; font-weight: 800; font-size: 1.3rem;
            border-left: 6px solid var(--primary-blue);
            display: flex; align-items: center; gap: 10px;
        }
        .practice-mode { margin-bottom: 60px; }

        .instruction-box {
            background: #e7f1ff; border-left: 5px solid #0d6efd;
            padding: 20px; border-radius: 6px; margin-bottom: 25px; color: #0c5460;
            font-size: 1.05rem;
        }
        body.dark-mode .instruction-box { background: #1a2634; border-color: #375a7f; color: #aab; }

        /* QUIZ GRID */
        .quiz-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 15px; margin-top: 15px;
        }
        .quiz-option {
            padding: 18px; text-align: center; font-weight: 600; font-size: 1.05rem;
            background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px;
            cursor: pointer; position: relative; transition: all 0.2s;
        }
        .quiz-option:hover { border-color: var(--primary-blue); background: rgba(13, 110, 253, 0.05); transform: translateY(-3px); }
        .quiz-option.correct { background: #d1e7dd; border-color: #198754; color: #0f5132; }
        .quiz-option.incorrect { background: #f8d7da; border-color: #dc3545; color: #842029; }

        /* STORY STYLES */
        .story-container {
            background: var(--card-bg); padding: 30px; border-radius: 12px;
            line-height: 2.4; font-size: 1.15rem; border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        .story-select {
            padding: 5px 10px; border-radius: 6px; border: 2px solid #0d6efd; 
            margin: 0 5px; font-size: 1rem; background: var(--bg-color); color: var(--text-color);
            cursor: pointer;
        }

        /* SORTER */
        .sorter-container { display: flex; flex-direction: column; gap: 25px; }
        .drag-source { 
            min-height: 120px; background: var(--bg-color); padding: 20px; 
            border-radius: 12px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;
            border: 2px solid var(--border-color);
        }
        .drop-zones { display: flex; gap: 20px; }
        .drop-zone {
            flex: 1; border: 3px dashed var(--border-color); border-radius: 12px;
            padding: 20px; min-height: 300px; text-align: center; transition: background 0.2s;
            background: rgba(0,0,0,0.01);
        }
        .drop-zone h3 { margin-bottom: 5px; font-size: 1.2rem; }
        
        .drag-item {
            background: white; border: 2px solid var(--primary-blue); color: var(--primary-blue);
            padding: 10px 18px; border-radius: 25px; cursor: grab; font-weight: 600; font-size: 0.95rem;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); user-select: none; touch-action: none;
        }
        .drag-item.correct { background: var(--green); color: white; border-color: var(--green); }
        .drag-item.incorrect { background: var(--red); color: white; border-color: var(--red); }
        body.dark-mode .drag-item { background: #2c2c2c; }

        /* PHRASE BANK */
        .phrase-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .phrase-card { 
            background: var(--card-bg); padding: 20px; border-radius: 12px; 
            border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: var(--shadow);
        }
        .phrase-actions { display: flex; justify-content: space-between; margin-top: 15px; align-items: center; }

        /* FLASHCARDS */
        .flashcard-container { perspective: 1000px; width: 100%; max-width: 550px; height: 380px; margin: 0 auto; cursor: pointer; }
        .card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 16px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 35px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .card-front { background: white; border: 3px solid #0d6efd; color: #333; }
        .card-back { background: #0d6efd; color: white; transform: rotateY(180deg); }
        body.dark-mode .card-front { background: #2c2c2c; color: white; border-color: #444; }

        .audio-btn-fc {
            margin-top: 15px; background: rgba(0,0,0,0.05); color: inherit; border: none;
            padding: 10px; border-radius: 50%; cursor: pointer; transition: transform 0.2s;
        }
        .audio-btn-fc:hover { transform: scale(1.2); background: rgba(0,0,0,0.1); }
        .card-back .audio-btn-fc { background: rgba(255,255,255,0.2); color: white; }
        .card-back .audio-btn-fc:hover { background: rgba(255,255,255,0.3); }

        /* MODAL */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: var(--card-bg); padding: 30px; border-radius: 16px;
            width: 90%; max-width: 550px; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #999; }
        .modal-header { border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; font-size: 1.8rem; color: var(--primary-blue); }
        .modal-body p { font-size: 1.1rem; line-height: 1.6; margin-bottom: 15px; }

    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-content">
            <h1 class="header-title">Adjective Clauses</h1>
            <span class="header-subtitle">Que, El cual, Donde & More</span>
        </div>
        <div class="header-controls">
            <button class="header-btn" onclick="toggleLang()" id="btnLang">EN / ES</button>
            <button class="header-btn" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('concept')"><span>üå°Ô∏è</span> <span data-key="tabConcept">The Concept</span></button>
        <button class="tab-btn" onclick="openTab('formula')"><span>‚úçÔ∏è</span> <span data-key="tabFormula">The Formula</span></button>
        <button class="tab-btn" onclick="openTab('phrases')"><span>üìö</span> <span data-key="tabPhrases">Phrase Bank</span></button>
        <button class="tab-btn" onclick="openTab('practice')"><span>üß†</span> <span data-key="tabPractice">Interactive Practice</span></button>
        <button class="tab-btn" onclick="openTab('flashcards')"><span>üÉè</span> <span data-key="tabFlashcards">Flashcards</span></button>
    </div>

    <!-- TAB: CONCEPT -->
    <div id="concept" class="tab-content active">
        <h2 data-key="linkingWordsTitle">Linking Words (Pronouns)</h2>
        
        <div class="concept-cards">
            <!-- Card 1 -->
            <div class="concept-card" style="border-top: 5px solid #17a2b8;">
                <span class="cc-icon">üì¶/üë§</span>
                <div class="cc-title">Que / El cual</div>
                <div class="cc-desc" data-key="descQue">Used for <b>Things</b> or <b>People</b>.<br>'Que' is the most common.</div>
                <div class="cc-example">"El libro <b>que</b> compr√©..."</div>
            </div>
            <!-- Card 2 -->
            <div class="concept-card" style="border-top: 5px solid #6610f2;">
                <span class="cc-icon">üè†</span>
                <div class="cc-title">Donde</div>
                <div class="cc-desc" data-key="descDonde">Used specifically for <b>Places</b>.</div>
                <div class="cc-example">"La ciudad <b>donde</b> vivo..."</div>
            </div>
            <!-- Card 3 -->
            <div class="concept-card" style="border-top: 5px solid #e83e8c;">
                <span class="cc-icon">üë§</span>
                <div class="cc-title">Quien / Quienes</div>
                <div class="cc-desc" data-key="descQuien">Used only for <b>People</b>, after a preposition.</div>
                <div class="cc-example">"La chica con <b>quien</b> habl√©..."</div>
            </div>
        </div>

        <h2 data-key="videoTitle">Video Tutorial</h2>
        <div class="video-container">
            <iframe class="video-frame" src="https://drive.google.com/file/d/1GvLKweVVyGK7NV56g-Lo3DvjSXqjQwW2/preview" allow="autoplay"></iframe>
        </div>

        <div class="interactive-formula">
            <h3 data-key="formulaTitle">Interactive Formula</h3>
            <p data-key="formulaInstr">Click buttons to visualize the structure:</p>
            <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                <button class="btn btn-outline" onclick="setFormula('thing')">Things (Que)</button>
                <button class="btn btn-outline" onclick="setFormula('person')">People (Quien)</button>
                <button class="btn btn-outline" onclick="setFormula('place')">Places (Donde)</button>
            </div>
            <div id="formulaCanvas" class="formula-display-area">
                <div class="big-emoji-row">üì¶ ‚û°Ô∏è <b>QUE</b></div>
                <div class="formula-text">Antecedent (Thing) + QUE + Verb</div>
            </div>
        </div>
    </div>

    <!-- TAB: FORMULA VISUAL -->
    <div id="formula" class="tab-content">
        <h2 data-key="tabFormula">The Formula</h2>
        <div class="instruction-box">
            <strong data-key="grammarNoteTitle">Grammar Note:</strong> 
            <span data-key="grammarNoteText">Remember that in Spanish, you cannot omit the relative pronoun like in English.</span>
            <br>
            ‚ùå <i>The book I read...</i> (Correct in English)<br>
            ‚úÖ <i>El libro <b>que</b> le√≠...</i> (Mandatory in Spanish)
        </div>

        <div class="formula-grid">
            <div class="formula-card">
                <div style="font-size:3rem;">üëë</div>
                <h3>The Universal "QUE"</h3>
                <div class="formula-rule">90% of cases</div>
                <p>Use for Things, People (Subject), and Abstract ideas.</p>
                <div class="cc-example">El chico <b>que</b> corre.</div>
            </div>

            <div class="formula-card">
                <div style="font-size:3rem;">üìç</div>
                <h3>Places "DONDE"</h3>
                <div class="formula-rule">Location</div>
                <p>Replaces "en el que" (in which).</p>
                <div class="cc-example">El hotel <b>donde</b> dorm√≠.</div>
            </div>

            <div class="formula-card">
                <div style="font-size:3rem;">üëâüë§</div>
                <h3>Prepositions "QUIEN"</h3>
                <div class="formula-rule">Preposition + Person</div>
                <p>After (a, con, de, por...).</p>
                <div class="cc-example">La chica <b>con quien</b> habl√©.</div>
            </div>

            <div class="formula-card">
                <div style="font-size:3rem;">üîë</div>
                <h3>Possession "CUYO"</h3>
                <div class="formula-rule">Whose</div>
                <p>Agrees with the possession, not the owner.</p>
                <div class="cc-example">El ni√±o <b>cuyo</b> perro...</div>
            </div>
        </div>
    </div>

    <!-- TAB: PHRASE BANK (WITH MODALS) -->
    <div id="phrases" class="tab-content">
        <h2 data-key="tabPhrases">Phrase Bank</h2>
        <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" onclick="filterPhrases('all')">All</button>
            <button class="btn btn-outline" onclick="filterPhrases('que')">Que</button>
            <button class="btn btn-outline" onclick="filterPhrases('donde')">Donde</button>
            <button class="btn btn-outline" onclick="filterPhrases('quien')">Quien</button>
            <button class="btn btn-outline" onclick="filterPhrases('cuyo')">Cuyo</button>
        </div>
        <div id="phraseContainer" class="phrase-grid"></div>
    </div>

    <!-- TAB: PRACTICE -->
    <div id="practice" class="tab-content">
        <!-- 1. QUIZ -->
        <div class="practice-section-title"><span>1Ô∏è‚É£</span> Quick Quiz (20 Questions)</div>
        <div class="practice-mode">
            <div class="instruction-box" data-key="quizInstr">Select the correct relative pronoun.</div>
            <div id="quiz-area"></div>
            <div class="action-btn-container">
                <button class="btn" onclick="generateQuiz()">üîÑ New Quiz</button>
            </div>
        </div>

        <!-- 2. STORIES (LONG) -->
        <div class="practice-section-title"><span>2Ô∏è‚É£</span> Story Gap Fill</div>
        <div class="practice-mode">
            <div class="instruction-box" data-key="storyInstr">Complete the story by selecting options.</div>
            <div id="story-area" class="story-container"></div>
            <div class="action-btn-container" style="display:flex; gap:15px; justify-content:center;">
                <button class="btn" onclick="checkStory()">‚úÖ Check Answers</button>
                <button class="btn btn-outline" onclick="loadStory()">‚û°Ô∏è Next Story</button>
            </div>
        </div>

        <!-- 3. SORTER -->
        <div class="practice-section-title"><span>3Ô∏è‚É£</span> Structure Sorter (Drag & Drop)</div>
        <div class="practice-mode">
            <div class="instruction-box" data-key="sorterInstr">Drag items to the correct category. (Tap on mobile)</div>
            <div class="sorter-container">
                <div id="dragSource" class="drag-source"></div>
                <div class="drop-zones">
                    <div class="drop-zone" id="zone-simple" ondragover="allowDrop(event)" ondrop="drop(event)" style="border-color:#0d6efd">
                        <h3 style="color:#0d6efd">Simple (QUE)</h3>
                        <p style="font-size:0.9rem">No Preposition / Direct Subject</p>
                    </div>
                    <div class="drop-zone" id="zone-complex" ondragover="allowDrop(event)" ondrop="drop(event)" style="border-color:#dc3545">
                        <h3 style="color:#dc3545">Complex / Prepositions</h3>
                        <p style="font-size:0.9rem">Quien, El cual, Donde, Cuyo...</p>
                    </div>
                </div>
            </div>
            <div class="action-btn-container">
                <button class="btn" onclick="checkSorter()">‚úÖ Validate Classification</button>
            </div>
        </div>
    </div>

    <!-- TAB: FLASHCARDS (BILINGUAL & WITH AUDIO) -->
    <div id="flashcards" class="tab-content">
        <div class="flashcard-container" onclick="flipCard(this)">
            <div id="cardInner" class="card-inner">
                <!-- Front (English) -->
                <div class="card-face card-front">
                    <h3 id="fcFront" style="font-weight:400; line-height:1.5; font-size:1.4rem;">English Sentence</h3>
                    <button class="audio-btn-fc" onclick="event.stopPropagation(); playCurrentCard('en')">üîä</button>
                    <p style="margin-top:20px; color:#aaa; font-size:0.9rem;">(Tap to flip)</p>
                </div>
                <!-- Back (Spanish) -->
                <div class="card-face card-back">
                    <h3 id="fcBack" style="font-weight:bold; line-height:1.4; font-size:1.4rem;">Espa√±ol</h3>
                    <button class="audio-btn-fc" onclick="event.stopPropagation(); playCurrentCard('es')">üîä</button>
                    <hr style="width:50%; opacity:0.3; margin:15px 0;">
                    <div style="text-align:left; width:100%;">
                        <p style="font-size:0.9rem; margin:5px 0;">üá¨üáß <span id="fcExpEn">Explanation</span></p>
                        <p style="font-size:0.9rem; margin:5px 0;">üá™üá∏ <span id="fcExpEs">Explicaci√≥n</span></p>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align:center; margin-top:30px;">
            <button class="btn" onclick="prevCard()">‚¨ÖÔ∏è Prev</button>
            <span id="fcCount" style="margin: 0 20px; font-weight:bold; font-size:1.2rem;">1/20</span>
            <button class="btn" onclick="nextCard()">Next ‚û°Ô∏è</button>
        </div>
    </div>

</div>

<!-- EXPLAIN MODAL -->
<div id="explainModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div class="modal-header">
            <h2 id="mTitle">Usage Explanation</h2>
        </div>
        <div class="modal-body">
            <p><strong>Context:</strong> <span id="mContext"></span></p>
            <p><strong>Translation:</strong> <span id="mTrans" style="font-style:italic; color:#666;"></span></p>
            <div style="background:#f0f4f8; padding:15px; border-radius:8px; margin-top:15px;">
                <strong>üí° Grammar Rule:</strong>
                <p id="mRule" style="margin-bottom:0; color:#0056b3;"></p>
            </div>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let currentLang = 'en';

    // --- TRANSLATIONS (NUEVO) ---
    const translations = {
        'tabConcept': { en: 'The Concept', es: 'El Concepto' },
        'tabFormula': { en: 'The Formula', es: 'La F√≥rmula' },
        'tabPhrases': { en: 'Phrase Bank', es: 'Banco de Frases' },
        'tabPractice': { en: 'Interactive Practice', es: 'Pr√°ctica Interactiva' },
        'tabFlashcards': { en: 'Flashcards', es: 'Tarjetas' },
        'linkingWordsTitle': { en: 'Linking Words (Pronouns)', es: 'Palabras de Enlace (Pronombres)' },
        'descQue': { 
            en: 'Used for <b>Things</b> or <b>People</b>.<br>\'Que\' is the most common.', 
            es: 'Usado para <b>Cosas</b> o <b>Personas</b>.<br>\'Que\' es el m√°s com√∫n.' 
        },
        'descDonde': { en: 'Used specifically for <b>Places</b>.', es: 'Usado espec√≠ficamente para <b>Lugares</b>.' },
        'descQuien': { en: 'Used only for <b>People</b>, after a preposition.', es: 'Usado solo para <b>Personas</b>, tras preposici√≥n.' },
        'videoTitle': { en: 'Video Tutorial', es: 'Video Tutorial' },
        'formulaTitle': { en: 'Interactive Formula', es: 'F√≥rmula Interactiva' },
        'formulaInstr': { en: 'Click buttons to visualize the structure:', es: 'Haz clic para visualizar la estructura:' },
        'grammarNoteTitle': { en: 'Grammar Note:', es: 'Nota Gramatical:' },
        'grammarNoteText': { 
            en: 'Remember that in Spanish, you cannot omit the relative pronoun like in English.', 
            es: 'Recuerda que en espa√±ol no puedes omitir el pronombre relativo como en ingl√©s.' 
        },
        'quizInstr': { en: 'Select the correct relative pronoun.', es: 'Selecciona el pronombre relativo correcto.' },
        'storyInstr': { en: 'Complete the story by selecting options.', es: 'Completa la historia seleccionando opciones.' },
        'sorterInstr': { en: 'Drag items to the correct category. (Tap on mobile)', es: 'Arrastra √≠tems a la categor√≠a correcta. (Toca en m√≥vil)' }
    };

    // --- DATA ---
    const storyData = [
        { 
            title: "El Vecino Misterioso", 
            content: "Tengo un vecino nuevo [1] es muy misterioso. Vive en la casa [2] est√° al final de la calle, la cual siempre tiene las cortinas cerradas. El perro con [3] pasea todas las noches parece muy agresivo. Nadie sabe de [4] trabaja, pero conduce un coche [5] cuesta una fortuna. La √∫nica persona con [6] habla es el cartero.",
            opts: {1:["que","donde"], 2:["que","quien"], 3:["quien","que"], 4:["donde","que"], 5:["que","donde"], 6:["la que","donde"]}, 
            ans: {1:"que", 2:"que", 3:"quien", 4:"que", 5:"que", 6:"la que"} 
        },
        { 
            title: "La Entrevista de Trabajo", 
            content: "Ayer tuve una entrevista en la empresa para la [1] siempre quise trabajar. La oficina [2] me citaron estaba en el piso 40, desde donde se ve√≠a toda la ciudad. El gerente, [3] oficina era enorme, me hizo muchas preguntas dif√≠ciles. Hab√≠a otros candidatos con [4] compet√≠a por el puesto. Al final, el proyecto del [5] me hablaron suena fascinante.",
            opts: {1:["que","quien"], 2:["donde","que"], 3:["cuya","que"], 4:["los que","donde"], 5:["que","quien"]}, 
            ans: {1:"que", 2:"donde", 3:"cuya", 4:"los que", 5:"que"} 
        },
        { 
            title: "Un Viaje Inolvidable", 
            content: "El verano pasado visitamos el pueblo [1] naci√≥ mi abuela. Es un lugar tranquilo [2] todo el mundo se conoce. Nos alojamos en una posada [3] due√±os eran encantadores. La comida [4] nos sirvieron era deliciosa y casera. Conocimos a un anciano a [5] todo el pueblo respetaba mucho por su sabidur√≠a.",
            opts: {1:["donde","que"], 2:["donde","quien"], 3:["cuyos","que"], 4:["que","quien"], 5:["quien","que"]}, 
            ans: {1:"donde", 2:"donde", 3:"cuyos", 4:"que", 5:"quien"} 
        }
    ];

    const quizData = [
        { q: "El libro ___ estoy leyendo es fascinante.", opts: ["que", "quien", "donde"], ans: "que", trans: "The book I am reading is fascinating." },
        { q: "La chica con ___ fui al cine se llama Ana.", opts: ["quien", "que", "cual"], ans: "quien", trans: "The girl with whom I went to the cinema is named Ana." },
        { q: "La casa ___ vivo es muy antigua.", opts: ["donde", "que", "quien"], ans: "donde", trans: "The house where I live is very old." },
        { q: "El hombre ___ me ayud√≥ era muy amable.", opts: ["que", "donde", "cuyo"], ans: "que", trans: "The man who helped me was very kind." },
        { q: "No entiendo lo ___ dices.", opts: ["que", "quien", "cual"], ans: "que", trans: "I don't understand what you are saying." },
        { q: "El restaurante en el ___ comimos era caro.", opts: ["que", "quien", "donde"], ans: "que", trans: "The restaurant in which we ate was expensive." },
        { q: "Mis amigos, ___ viven en Madrid, vendr√°n pronto.", opts: ["quienes", "que", "cuyos"], ans: "quienes", trans: "My friends, who live in Madrid, will come soon." },
        { q: "El motivo por el ___ lo hice es secreto.", opts: ["que", "quien", "donde"], ans: "que", trans: "The reason for which I did it is a secret." },
        { q: "La pluma con la ___ escribo es azul.", opts: ["que", "quien", "cual"], ans: "que", trans: "The pen with which I write is blue." },
        { q: "El alumno ___ padre es m√©dico es muy listo.", opts: ["cuyo", "que", "quien"], ans: "cuyo", trans: "The student whose father is a doctor is very smart." },
        { q: "La ciudad a la ___ voy es hermosa.", opts: ["que", "quien", "donde"], ans: "que", trans: "The city to which I am going is beautiful." },
        { q: "Esa es la mujer a ___ vi ayer.", opts: ["quien", "que", "donde"], ans: "quien", trans: "That is the woman whom I saw yesterday." },
        { q: "El coche ___ compr√© es r√°pido.", opts: ["que", "quien", "donde"], ans: "que", trans: "The car that I bought is fast." },
        { q: "El lugar ___ nos conocimos.", opts: ["donde", "que", "quien"], ans: "donde", trans: "The place where we met." },
        { q: "Las personas a ___ invit√© no vinieron.", opts: ["quienes", "que", "cuales"], ans: "quienes", trans: "The people whom I invited didn't come." },
        { q: "El edificio ___ ventanas son grandes.", opts: ["cuyas", "cuyo", "que"], ans: "cuyas", trans: "The building whose windows are big." },
        { q: "El problema del ___ hablamos.", opts: ["que", "quien", "donde"], ans: "que", trans: "The problem of which we spoke." },
        { q: "La silla en la ___ te sientas.", opts: ["que", "donde", "quien"], ans: "que", trans: "The chair in which you sit." },
        { q: "Es algo ___ me preocupa.", opts: ["que", "quien", "donde"], ans: "que", trans: "It's something that worries me." },
        { q: "El d√≠a ___ naciste llov√≠a.", opts: ["que", "donde", "quien"], ans: "que", trans: "The day (that) you were born it was raining." }
    ];

    const phraseBank = [
        {es: "El libro que compr√©.", en: "The book that I bought.", type: "que", rule: "Use 'que' for things (Direct Object)."},
        {es: "El lugar donde vivo.", en: "The place where I live.", type: "donde", rule: "Use 'donde' for physical locations."},
        {es: "La mujer con quien hablo.", en: "The woman with whom I speak.", type: "quien", rule: "Use 'quien' for people after a preposition (con)."},
        {es: "El chico que corre.", en: "The boy who runs.", type: "que", rule: "Use 'que' as the subject for a person."},
        {es: "El alumno cuyo padre...", en: "The student whose father...", type: "cuyo", rule: "'Cuyo' indicates possession and agrees with the following noun."},
        {es: "La raz√≥n por la que...", en: "The reason why...", type: "que", rule: "After prepositions, 'el/la que' is common for things."},
        {es: "Mis amigos, quienes viajan...", en: "My friends, who travel...", type: "quien", rule: "'Quienes' (plural) is used in non-defining clauses for people."},
        {es: "Lo que dices es verdad.", en: "What you say is true.", type: "que", rule: "'Lo que' refers to an abstract idea (what/that which)."}
    ];

    const flashcards = [
        { en: "The project on which we are working.", es: "El proyecto en el que trabajamos.", expEn: "Formal use: Prep + article + que.", expEs: "Uso formal: Prep + art√≠culo + que." },
        { en: "The village where I was born.", es: "El pueblo donde nac√≠.", expEn: "Donde replaces 'en el que'.", expEs: "Donde reemplaza a 'en el que'." },
        { en: "The candidate for whom I voted.", es: "El candidato por quien vot√©.", expEn: "Person after preposition = Quien.", expEs: "Persona tras preposici√≥n = Quien." },
        { en: "Students whose parents pay.", es: "Estudiantes cuyos padres pagan.", expEn: "Possession agrees with 'parents'.", expEs: "Posesi√≥n concuerda con 'padres'." },
        { en: "The reason why I left.", es: "La raz√≥n por la que me fui.", expEn: "Reason = Por la que.", expEs: "Causa = Por la que." },
        { en: "My boss, who is calm...", es: "Mi jefe, quien es tranquilo...", expEn: "Non-defining clause uses Quien.", expEs: "Cl√°usula explicativa usa Quien." },
        { en: "Everything that glitters.", es: "Todo lo que brilla.", expEn: "Abstract 'Everything' = Todo lo que.", expEs: "Abstracto 'Todo' = Todo lo que." },
        { en: "The tools with which he fixed it.", es: "Las herramientas con las que lo arregl√≥.", expEn: "Thing after prep = el/la/los/las que.", expEs: "Cosa tras prep = el/la/los/las que." },
        { en: "The person to whom I speak.", es: "La persona con quien hablo.", expEn: "Preposition + Quien.", expEs: "Preposici√≥n + Quien." },
        { en: "The moment (that) I saw her.", es: "El momento en que la vi.", expEn: "Time = en que / cuando.", expEs: "Tiempo = en que / cuando." },
        { en: "I don't know what you mean.", es: "No s√© lo que quieres decir.", expEn: "Abstract What = Lo que.", expEs: "Abstracto = Lo que." },
        { en: "The company for which I work.", es: "La empresa para la que trabajo.", expEn: "Entity/Thing = La que.", expEs: "Entidad/Cosa = La que." },
        { en: "Students who study pass.", es: "Los estudiantes que estudian aprueban.", expEn: "Simple Subject = Que.", expEs: "Sujeto Simple = Que." },
        { en: "The house, whose windows...", es: "La casa, cuyas ventanas...", expEn: "Agrees with windows (fem/pl).", expEs: "Concuerda con ventanas." },
        { en: "The folder in which I saved it.", es: "La carpeta en la que lo guard√©.", expEn: "In which = En la que.", expEs: "En la cual / En la que." },
        { en: "A writer whose books...", es: "Un escritor cuyos libros...", expEn: "Possession masculine plural.", expEs: "Posesi√≥n masc. plural." },
        { en: "The woman I was talking to.", es: "La mujer con quien hablaba.", expEn: "Prep must go before pronoun in Spanish.", expEs: "Prep va antes del pronombre." },
        { en: "The painting that cost a lot.", es: "El cuadro que cost√≥ mucho.", expEn: "Thing Subject = Que.", expEs: "Sujeto Cosa = Que." },
        { en: "The day when we met.", es: "El d√≠a en que nos conocimos.", expEn: "Time relative.", expEs: "Relativo de tiempo." },
        { en: "What helps me is support.", es: "Lo que me ayuda es el apoyo.", expEn: "Abstract subject.", expEs: "Sujeto abstracto." }
    ];

    const dragData = [
        {txt: "El libro QUE leo", type: "simple"}, {txt: "La casa DONDE vivo", type: "complex"},
        {txt: "Con QUIEN hablo", type: "complex"}, {txt: "El coche QUE compr√©", type: "simple"},
        {txt: "Por el CUAL", type: "complex"}, {txt: "Con EL QUE", type: "complex"},
        {txt: "Donde nac√≠", type: "complex"}, {txt: "El amigo QUE vino", type: "simple"},
        {txt: "A QUIEN vi", type: "complex"}, {txt: "Lo QUE dices", type: "simple"},
        {txt: "CUYO padre", type: "complex"}, {txt: "Algo QUE gusta", type: "simple"},
        {txt: "En LA QUE", type: "complex"}, {txt: "El pa√≠s QUE visit√©", type: "simple"},
        {txt: "Del QUE", type: "complex"}, {txt: "Cosas QUE haces", type: "simple"},
        {txt: "Por LA QUE", type: "complex"}, {txt: "El hombre QUE corre", type: "simple"},
        {txt: "Para QUIEN", type: "complex"}, {txt: "El gato QUE duerme", type: "simple"}
    ];

    // --- LOGIC ---
    let voices = [];
    
    function loadVoices() {
        voices = window.speechSynthesis.getVoices();
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function toggleLang() {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        document.getElementById('btnLang').innerText = currentLang.toUpperCase() + " / " + (currentLang==='en'?'ES':'EN');
        
        // REPARACI√ìN: Actualizar textos
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if (translations[key]) {
                el.innerHTML = translations[key][currentLang];
            }
        });
    }
    
    function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    // TTS MEJORADO: Auto-selecciona voces premium (Google/Microsoft)
    function speak(text, lang = 'es-ES') {
        window.speechSynthesis.cancel();
        
        // Detecci√≥n inteligente de pausas para guiones bajos
        // Reemplaza "___" por "..." para que la voz haga silencio en lugar de leer "guion bajo"
        const cleanText = text.replace(/_+/g, ' ... '); 
        
        const u = new SpeechSynthesisUtterance(cleanText);
        u.lang = lang;
        u.rate = 0.9; // Un poco m√°s lento para claridad educativa

        // Buscar voz Premium (Google o Microsoft) que coincida con el idioma solicitado
        if(voices.length > 0) {
            // Primer intento: Voz Premium exacta del idioma
            let bestVoice = voices.find(v => 
                v.lang.startsWith(lang.split('-')[0]) && 
                (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Premium'))
            );
            
            // Segundo intento: Cualquier voz del idioma
            if(!bestVoice) {
                bestVoice = voices.find(v => v.lang.startsWith(lang.split('-')[0]));
            }

            if(bestVoice) u.voice = bestVoice;
        }

        window.speechSynthesis.speak(u);
    }

    // Funciones espec√≠ficas para Flashcards
    function playCurrentCard(side) {
        const c = flashcards[fcIdx];
        if(side === 'en') speak(c.en, 'en-US');
        else speak(c.es, 'es-ES');
    }

    // Formula Visualizer
    function setFormula(type) {
        const c = document.getElementById('formulaCanvas');
        if(type==='thing') c.innerHTML = `<div class="big-emoji-row">üì¶ ‚û°Ô∏è <b>QUE</b></div><div class="formula-text">Antecedent (Thing) + QUE + Verb</div><div style="margin-top:10px;">Ex: El libro <b>que</b> leo.</div>`;
        if(type==='person') c.innerHTML = `<div class="big-emoji-row">üë§ ‚û°Ô∏è <b>QUIEN</b></div><div class="formula-text">Person + QUIEN (after prep) / QUE (Subject)</div><div style="margin-top:10px;">Ex: La chica con <b>quien</b> habl√©.</div>`;
        if(type==='place') c.innerHTML = `<div class="big-emoji-row">üè† ‚û°Ô∏è <b>DONDE</b></div><div class="formula-text">Location + DONDE + Verb</div><div style="margin-top:10px;">Ex: El hotel <b>donde</b> dorm√≠.</div>`;
    }

    // Phrase Bank
    function filterPhrases(type) {
        const c = document.getElementById('phraseContainer');
        c.innerHTML = '';
        const list = type === 'all' ? phraseBank : phraseBank.filter(p => p.type === type);
        list.forEach(p => {
            const card = document.createElement('div');
            card.className = 'phrase-card';
            card.innerHTML = `
                <div>
                    <h3 style="margin-top:0; color:#0056b3;">${p.es}</h3>
                    <p style="font-style:italic; color:#666;">${p.en}</p>
                </div>
                <div class="phrase-actions">
                    <button class="btn btn-outline" style="font-size:0.9rem; padding:6px 12px;" onclick="speak('${p.es.replace(/'/g, "\\'")}', 'es-ES')">üîä Listen</button>
                    <button class="btn" style="font-size:0.9rem; padding:6px 12px; background:#ffc107; color:#333;" onclick="openExplain('${p.type.replace(/'/g, "\\'")}', '${p.es.replace(/'/g, "\\'")}', '${p.en.replace(/'/g, "\\'")}', '${p.rule.replace(/'/g, "\\'")}')">üí° Explain</button>
                </div>
            `;
            c.appendChild(card);
        });
    }

    // Modal Logic
    function openExplain(type, es, en, rule) {
        document.getElementById('mTitle').innerText = type.toUpperCase() + " Clause";
        document.getElementById('mContext').innerText = es;
        document.getElementById('mTrans').innerText = en;
        document.getElementById('mRule').innerText = rule;
        document.getElementById('explainModal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('explainModal').style.display = 'none'; }

    // Quiz
    function generateQuiz() {
        const area = document.getElementById('quiz-area');
        area.innerHTML = '';
        const subset = quizData.sort(()=>0.5-Math.random()).slice(0, 20);
        subset.forEach((q, i) => {
            let html = `<div style="margin-bottom:20px; background:white; padding:20px; border-radius:12px; border:1px solid #eee; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <p style="font-size:1.1rem; margin-bottom:10px;"><strong>${i+1}. ${q.q}</strong> 
                <button onclick="speak('${q.q.replace(/'/g, "\\'")}', 'es-ES')" style="border:none;background:transparent;cursor:pointer; font-size:1.2rem;">üîä</button></p>
                <p style="font-size:0.9rem; color:#888; margin-bottom:15px;">${q.trans}</p>
                <div class="quiz-options-grid">`;
            q.opts.forEach(opt => {
                html += `<div class="quiz-option" onclick="checkQuiz(this, '${opt}', '${q.ans}')">${opt}</div>`;
            });
            html += `</div></div>`;
            area.innerHTML += html;
        });
    }

    function checkQuiz(el, val, ans) {
        if(el.parentElement.querySelector('.correct')) return;
        if(val === ans) el.classList.add('correct');
        else {
            el.classList.add('incorrect');
            Array.from(el.parentElement.children).forEach(c => { if(c.innerText === ans) c.classList.add('correct'); });
        }
    }

    // Stories
    let storyIdx = 0;
    function loadStory() {
        const s = storyData[storyIdx % storyData.length];
        storyIdx++;
        let html = `<h3 style="color:#0056b3; margin-top:0;">${s.title}</h3><div style="margin-top:15px;">${s.content}</div>`;
        Object.keys(s.opts).forEach(k => {
            html = html.replace(`[${k}]`, `<select data-ans="${s.ans[k]}" class="story-select"><option value="">...</option>${s.opts[k].map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`);
        });
        document.getElementById('story-area').innerHTML = html;
    }
    function checkStory() {
        document.querySelectorAll('.story-select').forEach(sel => {
            if(sel.value === sel.dataset.ans) { sel.style.background = '#d1e7dd'; sel.style.color = '#0f5132'; sel.style.borderColor='#198754'; }
            else { sel.style.background = '#f8d7da'; sel.style.color = '#842029'; sel.style.borderColor='#dc3545'; }
        });
    }

    // Sorter
    let draggedItem = null;
    let selectedMobileItem = null;

    function initSorter() {
        const src = document.getElementById('dragSource');
        src.innerHTML = '';
        dragData.sort(()=>0.5-Math.random()).forEach((item, i) => {
            const el = document.createElement('div');
            el.className = 'drag-item';
            el.draggable = true;
            el.innerText = item.txt;
            el.dataset.type = item.type;
            el.id = 'drag-'+i;
            el.ondragstart = (e) => { e.dataTransfer.setData('text', e.target.id); draggedItem = e.target; };
            el.addEventListener('click', (e) => handleTouchSelect(e.target));
            src.appendChild(el);
        });
    }
    
    function handleTouchSelect(el) {
        if(selectedMobileItem === el) {
            el.style.border = '2px solid var(--primary-blue)'; el.style.transform = 'scale(1)';
            selectedMobileItem = null; return;
        }
        if(selectedMobileItem) { selectedMobileItem.style.border = '2px solid var(--primary-blue)'; selectedMobileItem.style.transform = 'scale(1)'; }
        selectedMobileItem = el;
        el.style.border = '3px solid #ffc107'; el.style.transform = 'scale(1.1)';
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function drop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const el = document.getElementById(data);
        if(el) ev.target.closest('.drop-zone').appendChild(el);
    }
    document.querySelectorAll('.drop-zone').forEach(z => z.addEventListener('click', () => {
        if(selectedMobileItem) { z.appendChild(selectedMobileItem); selectedMobileItem.style.border='2px solid var(--primary-blue)'; selectedMobileItem.style.transform='scale(1)'; selectedMobileItem=null; }
    }));

    function checkSorter() {
        ['zone-simple','zone-complex'].forEach(id => {
            const type = id==='zone-simple'?'simple':'complex';
            Array.from(document.getElementById(id).children).forEach(c => {
                if(c.classList.contains('drag-item')) {
                    if(c.dataset.type===type) c.classList.add('correct'); else c.classList.add('incorrect');
                }
            });
        });
    }

    // Flashcards
    let fcIdx = 0;
    function flipCard(el) { 
        // Prevent flip if clicking audio button
        if(event.target.tagName === 'BUTTON') return;
        document.getElementById('cardInner').style.transform = document.getElementById('cardInner').style.transform === 'rotateY(180deg)' ? 'rotateY(0deg)' : 'rotateY(180deg)'; 
    }
    function nextCard() { fcIdx = (fcIdx + 1) % flashcards.length; updateFC(); }
    function prevCard() { fcIdx = (fcIdx - 1 + flashcards.length) % flashcards.length; updateFC(); }
    function updateFC() {
        document.getElementById('cardInner').style.transform = 'rotateY(0deg)';
        setTimeout(() => {
            const c = flashcards[fcIdx];
            document.getElementById('fcFront').innerText = c.en;
            document.getElementById('fcBack').innerText = c.es;
            document.getElementById('fcExpEn').innerText = c.expEn;
            document.getElementById('fcExpEs').innerText = c.expEs;
            document.getElementById('fcCount').innerText = (fcIdx+1)+'/'+flashcards.length;
        }, 300);
    }

    // Init
    window.onload = () => {
        // Force load voices immediately for Chrome
        loadVoices();
        
        filterPhrases('all');
        generateQuiz();
        loadStory();
        initSorter();
        updateFC();
    };

</script>
</body>
</html>
